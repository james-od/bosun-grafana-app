{"version":3,"sources":["../../src/datasource/queryBuilderService.js"],"names":["QueryBuilderService","variableOrderLength","variables","variableOrder","values","i","id","push","hasOwnProperty","value","startsWith","queryString","matching","replacement","split","join","finalQuery","controller","console","log","orderedVariablesList","target","length","buildWithProvidedOrdering","buildWithDefaultOrdering","sort","reverse","the_service","substitutedFinalQuery","forEach","type","variableIsValid","undefined","substituteVariable","buildQueryVariable","subbedQuery","queryVariable","arg","constructedQuery","ReferenceError","grouptagBoxes","onFirstTag","tagMapping","filtertagBoxes","queryVar","addQueryArg"],"mappings":"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","sourcesContent":["export class QueryBuilderService {\n\n  buildWithProvidedOrdering(variableOrderLength, variables, variableOrder, values) {\n    for (var i = 0; i < variableOrderLength; i++) {\n      variables[variableOrder[i].id][\"id\"] = variableOrder[i].id;\n      values.push(variables[variableOrder[i].id]);\n    }\n  }\n\n  buildWithDefaultOrdering(variables, values){\n    for (var id in variables) {\n      if (variables.hasOwnProperty(id)) {\n        variables[id][\"id\"] = id;\n        values.push(variables[id]);\n      }\n    }\n  }\n\n  variableIsValid(value){\n    return value[\"inputName\"] && value[\"inputName\"].startsWith(\"$\")\n  }\n\n  substituteVariable(queryString, matching, replacement){\n    return queryString.split(matching).join(replacement);\n  }\n\n  substituteFinalQuery(finalQuery, controller) {\n    console.log(controller)\n    //Dictionary doesn't guarantee ordering, so convert to array and sort by key\n    var orderedVariablesList = [];\n    const variables = controller.target.variables;\n    const variableOrder = controller.target.variableOrder;\n    const variableOrderLength = variableOrder.length;\n    if (variableOrderLength) {\n      this.buildWithProvidedOrdering(variableOrderLength, variables, variableOrder, orderedVariablesList);\n    } else {\n      this.buildWithDefaultOrdering(variables, orderedVariablesList);\n    }\n    orderedVariablesList.sort();\n    //Work upwards\n    orderedVariablesList = orderedVariablesList.reverse();\n\n    var the_service = this;\n\n    var substitutedFinalQuery = finalQuery;\n    orderedVariablesList.forEach(function (value) {\n      if (value.type === \"variable\") {\n        if (the_service.variableIsValid(value)) {\n          if (value[\"inputValue\"] === undefined) {\n            substitutedFinalQuery = the_service.substituteVariable(substitutedFinalQuery, value[\"inputName\"], \"\");\n          } else {\n            substitutedFinalQuery = the_service.substituteVariable(substitutedFinalQuery, value[\"inputName\"], value[\"inputValue\"]);\n          }\n        }\n      }\n      if (value.type === \"queryVariable\") {\n        substitutedFinalQuery = the_service.substituteVariable(substitutedFinalQuery, value[\"inputValue\"], the_service.buildQueryVariable(value, value.id, controller));\n      }\n    });\n    controller.target.subbedQuery = substitutedFinalQuery;\n    return substitutedFinalQuery;\n  }\n\n  addQueryArg(queryVariable, arg){\n    if(queryVariable[arg]){\n      if(arg === \"num\"){\n        return ', ' + queryVariable[arg]\n      }else{\n        return ', \"' + queryVariable[arg] + '\"'\n      }\n    }else{\n      return ', \"\"'\n    }\n  }\n\n  buildQueryVariable(queryVariable, id, controller) {\n    console.log(queryVariable)\n\n    var constructedQuery = \"\";\n    if(!queryVariable){throw new ReferenceError(\"No query parameters found\")}\n    if(!queryVariable[\"queryFunction\"]){throw new ReferenceError(\"Query function not set\")}\n    if(!queryVariable[\"queryAgg\"]){throw new ReferenceError(\"Query aggregator not set\")}\n    if(!queryVariable[\"metric\"]){throw new ReferenceError(\"Query metric not set\")}\n\n    constructedQuery += queryVariable[\"queryFunction\"] + '(\"';\n    constructedQuery += queryVariable[\"queryAgg\"] + \":\";\n    if(queryVariable[\"downsampleTime\"]){\n      constructedQuery += queryVariable[\"downsampleTime\"];\n      if(queryVariable[\"downsampleAgg\"]){\n        constructedQuery += \"-\" + queryVariable[\"downsampleAgg\"]\n      }\n      if(queryVariable[\"fillPolicy\"]){\n        constructedQuery += \"-\" + queryVariable[\"fillPolicy\"]\n      }\n    }else{\n      if(queryVariable[\"downsampleAgg\"]){\n        constructedQuery += queryVariable[\"downsampleAgg\"]\n      }\n      if(queryVariable[\"fillPolicy\"]){\n        constructedQuery += \"-\" + queryVariable[\"fillPolicy\"]\n      }\n    }\n    if(queryVariable[\"conversionFlag\"]){\n      constructedQuery += \":\" + queryVariable[\"conversionFlag\"]\n    }\n    if(queryVariable[\"flags\"]){\n      constructedQuery += \":\" + queryVariable[\"flags\"]\n    }\n    if(queryVariable[\"downsampleTime\"] || queryVariable[\"downsampleAgg\"] || queryVariable[\"fillPolicy\"]){\n      constructedQuery += \":\"\n    }\n    constructedQuery += queryVariable[\"metric\"] + \"{\";\n    if(controller.target.grouptagBoxes[id]) {\n      var onFirstTag = true;\n      for (var tagMapping in controller.target.grouptagBoxes[id]) {\n        if (controller.target.grouptagBoxes[id].hasOwnProperty(tagMapping)) {\n          if (!onFirstTag) {\n            constructedQuery += \",\"\n          } else {\n            onFirstTag = false;\n          }\n          constructedQuery += controller.target.grouptagBoxes[id][tagMapping][\"key\"] + \"=\" + controller.target.grouptagBoxes[id][tagMapping][\"value\"]\n        }\n      }\n    }\n    constructedQuery += \"}\";\n    if(controller.target.filtertagBoxes[id]){\n      var onFirstTag = true;\n\n      constructedQuery += \"{\";\n      for (var tagMapping in controller.target.filtertagBoxes[id]) {\n        if (controller.target.filtertagBoxes[id].hasOwnProperty(tagMapping)) {\n          if(!onFirstTag){\n            constructedQuery += \",\"\n          }else{onFirstTag = false;}\n          constructedQuery += controller.target.filtertagBoxes[id][tagMapping][\"key\"] + \"=\" + controller.target.filtertagBoxes[id][tagMapping][\"value\"]\n        }\n      }\n      constructedQuery += '}\"'\n    }else{\n      constructedQuery += '{}\"'\n    }\n    const queryVar = queryVariable[\"queryFunction\"]\n    if(queryVar === \"q\" || queryVar === \"change\" || queryVar === \"count\") {\n      constructedQuery += this.addQueryArg(queryVariable, \"startDuration\");\n      constructedQuery += this.addQueryArg(queryVariable, \"endDuration\");\n    }\n    if(queryVar === \"band\" || queryVar === \"over\" || queryVar === \"shiftBand\") {\n      constructedQuery += this.addQueryArg(queryVariable, \"duration\");\n      constructedQuery += this.addQueryArg(queryVariable, \"period\");\n      constructedQuery += this.addQueryArg(queryVariable, \"num\");\n    }\n    if(queryVar === \"window\") {\n      constructedQuery += this.addQueryArg(queryVariable, \"duration\");\n      constructedQuery += this.addQueryArg(queryVariable, \"period\");\n      constructedQuery += this.addQueryArg(queryVariable, \"num\");\n      constructedQuery += this.addQueryArg(queryVariable, \"funcName\");\n    }\n    constructedQuery += \")\";\n    console.log(constructedQuery);\n    return constructedQuery;\n  }\n}\n"],"file":"queryBuilderService.js"}