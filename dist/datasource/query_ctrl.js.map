{"version":3,"sources":["../../src/datasource/query_ctrl.js"],"names":["QueryCtrl","BosunDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","$sce","scope","sce","queryHelper","target","expandHelper","suggestMetrics","bind","addSuggest","labelFromUnit","metricInfo","suggestQuery","suggestTagValues","getSubstitutedFinalQuery","addNewVariable","addNewVariableQ","getMetricSuggestions","buildQueryVariable","addTagBox","filterTypes","variables","aggOptions","text","fillPolicies","queryFunctions","func","type","args","suggestions","tagBoxes","varCounter","tagBoxCounter","finalQuery","metric","callback","datasource","_metricsStartWith","then","_tagKeysForMetric","tagKeys","q","all","_","map","tagKey","_tagValuesForMetricAndTagKey","tagValues","key","value","tagKeysToValues","each","v","filterType","_metricMetadata","metadata","rate","Rate","unit","Unit","desc","Desc","panelCtrl","panel","yaxes","label","postfix","selectedGroupByTags","selectedFilterTags","selectedValue","push","suggestedQuery","join","refresh","typeahead","openTSDBUrl","ReferenceError","request","Request","the_scope","req","fetch","response","json","responseSuggestions","error","values","Array","id","sort","reverse","substitutedFinalQuery","forEach","startsWith","undefined","split","console","log","inputValue","parameterObject","params","constructedQuery","onFirstTag","tagMapping","hasOwnProperty","inputType","inputName","queryId","tagId","input","parseInt","expr","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQA,MAAAA,S,kBAAAA,S;;;0CAOKC,wB;;;AAEX,0CAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,YAA/B,EAA6CC,IAA7C,EAAmD;AAAA;;AAAA;;AACjD,wGAAMH,MAAN,EAAcC,SAAd,EAAyBE,IAAzB;AACA,gBAAKC,KAAL,GAAaJ,MAAb;AACA,gBAAKK,GAAL,GAAWF,IAAX;AACA,gBAAKG,WAAL,GAAmB,EAAnB;AACA,gBAAKJ,YAAL,GAAoBA,YAApB;AACA,gBAAKK,MAAL,CAAYC,YAAZ,GAA2B,CAA3B;AACA,gBAAKD,MAAL,CAAYA,MAAZ,GAAqB,MAAKA,MAAL,CAAYA,MAAZ,IAAsB,aAA3C;AACA,gBAAKE,cAAL,GAAsB,MAAKA,cAAL,CAAoBC,IAApB,+BAAtB;AACA,gBAAKC,UAAL,GAAkB,MAAKA,UAAL,CAAgBD,IAAhB,+BAAlB;AACA,gBAAKE,aAAL,GAAqB,MAAKA,aAAL,CAAmBF,IAAnB,+BAArB;AACA,gBAAKG,UAAL,GAAkB,MAAKA,UAAL,CAAgBH,IAAhB,+BAAlB;AACA,gBAAKI,YAAL,GAAoB,MAAKA,YAAL,CAAkBJ,IAAlB,+BAApB;AACA,gBAAKK,gBAAL,GAAwB,MAAKA,gBAAL,CAAsBL,IAAtB,+BAAxB;AACA,gBAAKM,wBAAL,GAAgC,MAAKA,wBAAL,CAA8BN,IAA9B,+BAAhC;AACA,gBAAKO,cAAL,GAAsB,MAAKA,cAAL,CAAoBP,IAApB,+BAAtB;AACA,gBAAKQ,eAAL,GAAuB,MAAKA,eAAL,CAAqBR,IAArB,+BAAvB;AACA,gBAAKS,oBAAL,GAA4B,MAAKA,oBAAL,CAA0BT,IAA1B,+BAA5B;AACA,gBAAKU,kBAAL,GAA0B,MAAKA,kBAAL,CAAwBV,IAAxB,+BAA1B;AACA,gBAAKW,SAAL,GAAiB,MAAKA,SAAL,CAAeX,IAAf,+BAAjB;AACA,gBAAKY,WAAL,GAAmB,CAAC,UAAD,EAAa,QAAb,CAAnB;AACA,gBAAKlB,KAAL,CAAWmB,SAAX,GAAuB,EAAvB;AACA,gBAAKnB,KAAL,CAAWoB,UAAX,GAAwB,CAAC;AAACC,YAAAA,IAAI,EAAE;AAAP,WAAD,EAAgB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhB,EAAiC;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAjC,EAAgD;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhD,EAAgE;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhE,EAAkF;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAlF,EAAoG;AAACA,YAAAA,IAAI,EAAE;AAAP,WAApG,EAAsH;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAtH,EAAwI;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAxI,EAA0J;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA1J,EAA4K;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA5K,EAA8L;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA9L,EAAgN;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhN,EAAkO;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAlO,EAAoP;AAACA,YAAAA,IAAI,EAAE;AAAP,WAApP,EAAuQ;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAvQ,EAA0R;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA1R,EAA2S;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA3S,EAA2T;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA3T,EAA6U;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA7U,EAA+V;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA/V,EAAiX;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAjX,EAAgY;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhY,EAA+Y;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA/Y,EAA+Z;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA/Z,EAA+a;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA/a,EAA8b;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA9b,EAA6c;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA7c,EAA4d;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA5d,EAA2e;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA3e,EAA0f;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA1f,EAA0gB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA1gB,EAA2hB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA3hB,EAA0iB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAA1iB,CAAxB;AACA,gBAAKrB,KAAL,CAAWsB,YAAX,GAA0B,CAAC;AAACD,YAAAA,IAAI,EAAE;AAAP,WAAD,EAAiB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAjB,EAAgC;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhC,EAAgD;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhD,CAA1B;AACA,gBAAKrB,KAAL,CAAWuB,cAAX,GAA4B,CAC1B;AAACC,YAAAA,IAAI,EAAE,GAAP;AAAYC,YAAAA,IAAI,EAAC,WAAjB;AAA8BC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,+BAAiB,QAArC;AAA+C,6BAAe;AAA9D;AAAnC,WAD0B,EAE1B;AAACF,YAAAA,IAAI,EAAE,MAAP;AAAeC,YAAAA,IAAI,EAAC,WAApB;AAAiCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO;AAArE;AAAtC,WAF0B,EAG1B;AAACF,YAAAA,IAAI,EAAE,MAAP;AAAeC,YAAAA,IAAI,EAAC,WAApB;AAAiCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO;AAArE;AAAtC,WAH0B,EAI1B;AAACF,YAAAA,IAAI,EAAE,WAAP;AAAoBC,YAAAA,IAAI,EAAC,WAAzB;AAAsCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO;AAArE;AAA3C,WAJ0B,EAK1B;AAACF,YAAAA,IAAI,EAAE,QAAP;AAAiBC,YAAAA,IAAI,EAAC,WAAtB;AAAmCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,+BAAiB,QAArC;AAA+C,6BAAe;AAA9D;AAAxC,WAL0B,EAM1B;AAACF,YAAAA,IAAI,EAAE,OAAP;AAAgBC,YAAAA,IAAI,EAAC,QAArB;AAA+BC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,+BAAiB,QAArC;AAA+C,6BAAe;AAA9D;AAApC,WAN0B,EAO1B;AAACF,YAAAA,IAAI,EAAE,QAAP;AAAiBC,YAAAA,IAAI,EAAC,WAAtB;AAAmCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO,QAArE;AAA+E,0BAAY;AAA3F;AAAxC,WAP0B,CAA5B;AASA,gBAAK1B,KAAL,CAAW2B,WAAX,GAAyB,EAAzB;AACA,gBAAK3B,KAAL,CAAW4B,QAAX,GAAsB,EAAtB;AACA,gBAAK5B,KAAL,CAAW6B,UAAX,GAAwB,CAAxB;AACA,gBAAK7B,KAAL,CAAW8B,aAAX,GAA2B,CAA3B;AACA,gBAAK9B,KAAL,CAAW+B,UAAX,GAAwB,EAAxB;AArCiD;AAsClD;;;;yCAEcC,M,EAAQC,Q,EAAU;AAC/B,mBAAO,KAAKC,UAAL,CAAgBC,iBAAhB,CAAkCH,MAAlC,EAA0CI,IAA1C,CAA+CH,QAA/C,CAAP;AACD;;;uCAEY;AAAA;;AACX,mBAAO,KAAKC,UAAL,CAAgBG,iBAAhB,CAAkC,KAAKnC,WAAL,CAAiB8B,MAAnD,EAA2DI,IAA3D,CAAgE,UAACE,OAAD,EAAa;AAClF,cAAA,MAAI,CAACJ,UAAL,CAAgBK,CAAhB,CAAkBC,GAAlB,CAAsBC,CAAC,CAACC,GAAF,CAAMJ,OAAN,EAAe,UAACK,MAAD,EAAY;AAC/C,uBAAO,MAAI,CAACT,UAAL,CAAgBU,4BAAhB,CAA6C,MAAI,CAAC1C,WAAL,CAAiB8B,MAA9D,EAAsEW,MAAtE,EAA8EP,IAA9E,CAAmF,UAACS,SAAD,EAAe;AACvG,yBAAO;AAAEC,oBAAAA,GAAG,EAAEH,MAAP;AAAeI,oBAAAA,KAAK,EAAEF;AAAtB,mBAAP;AACD,iBAFM,CAAP;AAGD,eAJqB,CAAtB,EAKET,IALF,CAKO,UAACY,eAAD,EAAqB;AAC1BA,gBAAAA,eAAe,GAAGP,CAAC,CAACQ,IAAF,CAAOD,eAAP,EAAwB,UAACE,CAAD,EAAO;AAAEA,kBAAAA,CAAC,CAACC,UAAF,GAAe,UAAf;AAA2B,iBAA5D,CAAlB;AACA,gBAAA,MAAI,CAACjD,WAAL,CAAiB8C,eAAjB,GAAmCA,eAAnC;AACD,eARD;AASD,aAVM,EAUJZ,IAVI,CAUC;AAAA,qBAAM,MAAI,CAACF,UAAL,CAAgBkB,eAAhB,CAAgC,MAAI,CAAClD,WAAL,CAAiB8B,MAAjD,EAAyDI,IAAzD,CAA8D,UAACiB,QAAD,EAAc;AACxF,gBAAA,MAAI,CAACnD,WAAL,CAAiBoD,IAAjB,GAAwBD,QAAQ,CAACE,IAAjC;AACA,gBAAA,MAAI,CAACrD,WAAL,CAAiBsD,IAAjB,GAAwBH,QAAQ,CAACI,IAAjC;AACA,gBAAA,MAAI,CAACvD,WAAL,CAAiBwD,IAAjB,GAAwBL,QAAQ,CAACM,IAAjC;AACD,eAJa,CAAN;AAAA,aAVD,EAcHvB,IAdG,CAcE;AAAA,qBAAM,MAAI,CAAC1B,YAAL,EAAN;AAAA,aAdF,CAAP;AAeD;;;2CAGgBoC,G,EAAKb,Q,EAAU;AAC9B,mBAAO,KAAK/B,WAAL,CAAiB8C,eAAjB,CAAiCF,GAAjC,EAAsCV,IAAtC,CAA2CH,QAA3C,CAAP;AACD;;;0CAEe;AACd,gBAAI,KAAK2B,SAAL,CAAeC,KAAf,CAAqBpC,IAArB,KAA8B,OAAlC,EAA2C;AACzC,mBAAKmC,SAAL,CAAeC,KAAf,CAAqBC,KAArB,CAA2B,CAA3B,EAA8BC,KAA9B,GAAsC,KAAK7D,WAAL,CAAiBsD,IAAvD;AACD;;AACD,gBAAI,KAAKI,SAAL,CAAeC,KAAf,CAAqBpC,IAArB,KAA8B,YAAlC,EAAgD;AAC9C,mBAAKmC,SAAL,CAAeC,KAAf,CAAqBG,OAArB,GAA+B,MAAM,KAAK9D,WAAL,CAAiBsD,IAAtD;AACD;AACF;;;yCAEc;AAAA;;AACb,gBAAIxB,MAAM,GAAG,KAAK9B,WAAL,CAAiB8B,MAAjB,IAA2B,kBAAxC;AACA,gBAAIiC,mBAAmB,GAAG,EAA1B;AACA,gBAAIC,kBAAkB,GAAG,EAAzB;;AACAzB,YAAAA,CAAC,CAACQ,IAAF,CAAO,KAAK/C,WAAL,CAAiB8C,eAAxB,EAAyC,UAACE,CAAD,EAAO;AAC9C,kBAAIA,CAAC,CAACiB,aAAF,IAAmBjB,CAAC,CAACiB,aAAF,IAAmB,EAA1C,EAA8C;AAC5C,oBAAIjB,CAAC,CAACC,UAAF,KAAiB,MAAI,CAACjC,WAAL,CAAiB,CAAjB,CAArB,EAA0C;AACxC+C,kBAAAA,mBAAmB,CAACG,IAApB,CAAyBlB,CAAC,CAACJ,GAAF,GAAQ,GAAR,GAAcI,CAAC,CAACiB,aAAzC;AACD;;AACD,oBAAIjB,CAAC,CAACC,UAAF,KAAiB,MAAI,CAACjC,WAAL,CAAiB,CAAjB,CAArB,EAA0C;AACxCgD,kBAAAA,kBAAkB,CAACE,IAAnB,CAAwBlB,CAAC,CAACJ,GAAF,GAAQ,GAAR,GAAcI,CAAC,CAACiB,aAAxC;AACD;AACF;AACF,aATD,EASG,IATH;;AAUA,gBAAIb,IAAI,GAAG,EAAX;;AACA,gBAAI,KAAKpD,WAAL,CAAiBoD,IAAjB,IAAyB,KAAKpD,WAAL,CAAiBoD,IAAjB,IAAyB,SAAtD,EAAiE;AAC/DA,cAAAA,IAAI,GAAG,mBAAP;AACD;;AACD,iBAAKpD,WAAL,CAAiBmE,cAAjB,GAAkC,qBAAqBf,IAArB,GAA4BtB,MAA5B,GAAqC,GAArC,GAA2CiC,mBAAmB,CAACK,IAApB,CAAyB,GAAzB,CAA3C,GAA2E,GAA3E,GAAiF,GAAjF,GAAuFJ,kBAAkB,CAACI,IAAnB,CAAwB,GAAxB,CAAvF,GAAsH,GAAtH,GAA4H,uBAA9J;AACD;;;6CAEkB;AACjB,iBAAKV,SAAL,CAAeW,OAAf,GADiB,CACS;AAC3B;;;+CAEoBC,S,EAAW;AAC9B,gBAAG,CAAC,KAAKtC,UAAL,CAAgBuC,WAApB,EAAgC;AAC9B,oBAAMC,cAAc,CAAC,sBAAD,CAApB;AACD;;AACD,gBAAIC,OAAO,GAAG,IAAIC,OAAJ,CAAY,KAAK1C,UAAL,CAAgBuC,WAAhB,GAA8B,0BAA9B,GAA2DD,SAAvE,CAAd;AAEA,gBAAIK,SAAS,GAAG,KAAK7E,KAArB;AACA,gBAAI8E,GAAG,GAAGC,KAAK,CAACJ,OAAD,CAAL,CAAevC,IAAf,CAAoB,UAAS4C,QAAT,EAAmB;AAC/C,qBAAOA,QAAQ,CAACC,IAAT,EAAP;AACD,aAFS,EAEP7C,IAFO,CAEF,UAAS8C,mBAAT,EAA8B;AACpCL,cAAAA,SAAS,CAAClD,WAAV,GAAwBuD,mBAAxB;AACD,aAJS,WAID,UAASC,KAAT,EAAgB;AACvB,oBAAMA,KAAN;AACD,aANS,CAAV;AAOA,iBAAKvB,SAAL,CAAeW,OAAf;AACA,mBAAOO,GAAP;AACD;;;mDAEwB/C,U,EAAY;AACnC;AACA,gBAAIqD,MAAM,GAAG,IAAIC,KAAJ,EAAb;;AACA,iBAAK,IAAIC,EAAT,IAAe,KAAKtF,KAAL,CAAWmB,SAA1B,EAAqC;AACnC,mBAAKnB,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,EAAyB,IAAzB,IAAiCA,EAAjC;AACAF,cAAAA,MAAM,CAAChB,IAAP,CAAY,KAAKpE,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,CAAZ;AACD;;AACDF,YAAAA,MAAM,CAACG,IAAP;AACAH,YAAAA,MAAM,GAAGA,MAAM,CAACI,OAAP,EAAT;AAEA,gBAAIX,SAAS,GAAG,IAAhB;AAEA,gBAAIY,qBAAqB,GAAG1D,UAA5B;AACAqD,YAAAA,MAAM,CAACM,OAAP,CAAe,UAAS3C,KAAT,EAAgB;AAC7B,kBAAGA,KAAK,CAACtB,IAAN,IAAc,UAAjB,EAA6B;AAE3B,oBAAIsB,KAAK,CAAC,MAAD,CAAL,IAAiBA,KAAK,CAAC,MAAD,CAAL,CAAc4C,UAAd,CAAyB,GAAzB,CAArB,EAAoD;AAClD,sBAAI5C,KAAK,CAAC,OAAD,CAAL,IAAkB6C,SAAtB,EAAiC;AAC/BH,oBAAAA,qBAAqB,GAAGA,qBAAqB,CAACI,KAAtB,CAA4B9C,KAAK,CAAC,MAAD,CAAjC,EAA2CuB,IAA3C,CAAgD,EAAhD,CAAxB;AACD,mBAFD,MAEO;AACLmB,oBAAAA,qBAAqB,GAAGA,qBAAqB,CAACI,KAAtB,CAA4B9C,KAAK,CAAC,MAAD,CAAjC,EAA2CuB,IAA3C,CAAgDvB,KAAK,CAAC,OAAD,CAArD,CAAxB;AACD;AACF;AACF;;AACD,kBAAGA,KAAK,CAACtB,IAAN,IAAc,eAAjB,EAAkC;AAChCgE,gBAAAA,qBAAqB,GAAGA,qBAAqB,CAACI,KAAtB,CAA4B9C,KAAK,CAACA,KAAN,CAAY,mBAAZ,CAA5B,EAA8DuB,IAA9D,CAAmEO,SAAS,CAAC7D,kBAAV,CAA6B+B,KAA7B,EAAoCA,KAAK,CAACuC,EAA1C,CAAnE,CAAxB;AACD;AACF,aAdD;AAeA,mBAAOG,qBAAP;AACD;;;2CAEgB1D,U,EAAY;AAC3B,iBAAK/B,KAAL,CAAW+B,UAAX,GAAwBA,UAAxB;AACA+D,YAAAA,OAAO,CAACC,GAAR,CAAY,KAAKnF,wBAAL,CAA8BmB,UAA9B,CAAZ;AACA,iBAAK6B,SAAL,CAAeW,OAAf;AACD;;;2CAEgByB,U,EAAYV,E,EAAI;AAC/B,gBAAG,KAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,CAAH,EAA4B;AAC1B,mBAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,EAAyB,OAAzB,IAAoCU,UAApC;AACD,aAFD,MAEK;AACH,oBAAM,IAAItB,cAAJ,CAAmB,uEAAnB,CAAN;AACD;;AACD,iBAAKd,SAAL,CAAeW,OAAf;AACD;;;6CAEkB0B,e,EAAiBX,E,EAAI;AAEtC,gBAAI1F,MAAM,GAAG,KAAKI,KAAlB;AACA,gBAAIkG,MAAM,GAAGD,eAAe,CAAClD,KAA7B;AACA,gBAAIoD,gBAAgB,GAAG,EAAvB;;AACA,gBAAG,CAACD,MAAJ,EAAW;AACT,oBAAM,IAAIxB,cAAJ,CAAmB,2BAAnB,CAAN;AACD;;AACD,gBAAGwB,MAAM,CAAC,eAAD,CAAT,EAA2B;AACzBC,cAAAA,gBAAgB,IAAID,MAAM,CAAC,eAAD,CAAN,GAA0B,IAA9C;AACD,aAFD,MAEK;AACH,oBAAM,IAAIxB,cAAJ,CAAmB,wBAAnB,CAAN;AACD;;AACD,gBAAGwB,MAAM,CAAC,UAAD,CAAT,EAAsB;AACpBC,cAAAA,gBAAgB,IAAID,MAAM,CAAC,UAAD,CAAN,GAAqB,GAAzC;AACD,aAFD,MAEK;AACH,oBAAM,IAAIxB,cAAJ,CAAmB,0BAAnB,CAAN;AACD;;AACD,gBAAGwB,MAAM,CAAC,gBAAD,CAAT,EAA4B;AAC1BC,cAAAA,gBAAgB,IAAID,MAAM,CAAC,gBAAD,CAA1B;;AACA,kBAAGA,MAAM,CAAC,eAAD,CAAT,EAA2B;AACzBC,gBAAAA,gBAAgB,IAAI,MAAMD,MAAM,CAAC,eAAD,CAAhC;AACD;;AACD,kBAAGA,MAAM,CAAC,YAAD,CAAT,EAAwB;AACtBC,gBAAAA,gBAAgB,IAAI,MAAMD,MAAM,CAAC,YAAD,CAAhC;AACD;AACF;;AACD,gBAAGA,MAAM,CAAC,gBAAD,CAAT,EAA4B;AAC1BC,cAAAA,gBAAgB,IAAI,MAAMD,MAAM,CAAC,gBAAD,CAAhC;AACD;;AACD,gBAAGA,MAAM,CAAC,QAAD,CAAT,EAAoB;AAClBC,cAAAA,gBAAgB,IAAI,MAAMD,MAAM,CAAC,QAAD,CAAZ,GAAyB,GAA7C;AACD,aAFD,MAEK;AACH,oBAAM,IAAIxB,cAAJ,CAAmB,sBAAnB,CAAN;AACD;;AACD,gBAAGwB,MAAM,CAAC,YAAD,CAAT,EAAwB;AACtBC,cAAAA,gBAAgB,IAAID,MAAM,CAAC,YAAD,CAA1B;AACD;;AACDC,YAAAA,gBAAgB,IAAI,GAApB;;AACA,gBAAGvG,MAAM,CAACgC,QAAP,CAAgB0D,EAAhB,CAAH,EAAuB;AACrB,kBAAIc,UAAU,GAAG,IAAjB;AAEAD,cAAAA,gBAAgB,IAAI,GAApB;;AACA,mBAAK,IAAIE,UAAT,IAAuBzG,MAAM,CAACgC,QAAP,CAAgB0D,EAAhB,CAAvB,EAA4C;AAC1C,oBAAI1F,MAAM,CAACgC,QAAP,CAAgB0D,EAAhB,EAAoBgB,cAApB,CAAmCD,UAAnC,CAAJ,EAAoD;AAClD,sBAAG,CAACD,UAAJ,EAAe;AACbD,oBAAAA,gBAAgB,IAAI,IAApB;AACD,mBAFD,MAEK;AAACC,oBAAAA,UAAU,GAAG,KAAb;AAAoB;;AAC1BD,kBAAAA,gBAAgB,IAAIvG,MAAM,CAACgC,QAAP,CAAgB0D,EAAhB,EAAoBe,UAApB,EAAgC,KAAhC,IAAyC,GAAzC,GAA+CzG,MAAM,CAACgC,QAAP,CAAgB0D,EAAhB,EAAoBe,UAApB,EAAgC,OAAhC,CAAnE;AACD;AACF;;AACDF,cAAAA,gBAAgB,IAAI,IAApB;AACD,aAbD,MAaK;AACHA,cAAAA,gBAAgB,IAAI,KAApB;AACD;;AACD,gBAAGD,MAAM,CAAC,eAAD,CAAT,EAA2B;AACzBC,cAAAA,gBAAgB,IAAI,QAAQD,MAAM,CAAC,eAAD,CAAd,GAAkC,GAAtD;AACD;;AACD,gBAAGA,MAAM,CAAC,aAAD,CAAT,EAAyB;AACvBC,cAAAA,gBAAgB,IAAI,QAAQD,MAAM,CAAC,aAAD,CAAd,GAAgC,GAApD;AACD;;AACD,gBAAGA,MAAM,CAAC,UAAD,CAAT,EAAsB;AACpBC,cAAAA,gBAAgB,IAAI,QAAQD,MAAM,CAAC,UAAD,CAAd,GAA6B,GAAjD;AACD;;AACD,gBAAGA,MAAM,CAAC,QAAD,CAAT,EAAoB;AAClBC,cAAAA,gBAAgB,IAAI,QAAQD,MAAM,CAAC,QAAD,CAAd,GAA2B,GAA/C;AACD;;AACD,gBAAGA,MAAM,CAAC,KAAD,CAAT,EAAiB;AACfC,cAAAA,gBAAgB,IAAI,QAAQD,MAAM,CAAC,KAAD,CAAd,GAAwB,GAA5C;AACD;;AACD,gBAAGA,MAAM,CAAC,UAAD,CAAT,EAAsB;AACpBC,cAAAA,gBAAgB,IAAI,QAAQD,MAAM,CAAC,UAAD,CAAd,GAA6B,GAAjD;AACD;;AACDC,YAAAA,gBAAgB,IAAI,GAApB;AACA,iBAAKvC,SAAL,CAAeW,OAAf;AACAuB,YAAAA,OAAO,CAACC,GAAR,CAAYI,gBAAZ;AACA,mBAAOA,gBAAP;AACD;;;oDAEyBI,S,EAAWP,U,EAAYV,E,EAAI;AACnD,gBAAG,KAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,CAAH,EAA4B;AAC1B,kBAAG,CAAC,KAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,EAAyB,OAAzB,CAAJ,EAAsC;AACpC,qBAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,EAAyB,OAAzB,IAAoC,EAApC;AACD;;AACD,mBAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,EAAyB,OAAzB,EAAkCiB,SAAlC,IAA+CP,UAA/C;AACD,aALD,MAKK;AACH,oBAAM,IAAItB,cAAJ,CAAmB,+CAAnB,CAAN;AACD;;AACD,iBAAKd,SAAL,CAAeW,OAAf;AACD;;;0CAEeiC,S,EAAWlB,E,EAAI;AAC7B,gBAAG,KAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,CAAH,EAA4B;AAC1B,mBAAKtF,KAAL,CAAWmB,SAAX,CAAqBmE,EAArB,EAAyB,MAAzB,IAAmCkB,SAAnC;AACD,aAFD,MAEK;AACH,oBAAM,IAAI9B,cAAJ,CAAmB,sEAAnB,CAAN;AACD;;AACD,iBAAKd,SAAL,CAAeW,OAAf;AACD;;;2CAEgB;AACf,iBAAKvE,KAAL,CAAWmB,SAAX,CAAqB,KAAKnB,KAAL,CAAW6B,UAAhC,IAA8C;AAACJ,cAAAA,IAAI,EAAE;AAAP,aAA9C;AACA,iBAAKzB,KAAL,CAAW6B,UAAX,IAAyB,CAAzB;AACA,iBAAK+B,SAAL,CAAeW,OAAf;AACD;;;4CAEiB;AAChBuB,YAAAA,OAAO,CAACC,GAAR,CAAY,KAAK/F,KAAjB;AACA,iBAAKA,KAAL,CAAWmB,SAAX,CAAqB,KAAKnB,KAAL,CAAW6B,UAAhC,IAA8C;AAACJ,cAAAA,IAAI,EAAE;AAAP,aAA9C;AACA,iBAAKzB,KAAL,CAAW6B,UAAX,IAAyB,CAAzB;AACA,iBAAK+B,SAAL,CAAeW,OAAf;AACD;;;8CAEmBxC,U,EAAY;AAC9B;AACA,iBAAK6B,SAAL,CAAeW,OAAf;AACD;;;qCAEUkC,O,EAASC,K,EAAOC,K,EAAOlF,I,EAAM;AACtC,iBAAKzB,KAAL,CAAW4B,QAAX,CAAoBgF,QAAQ,CAACH,OAAD,CAA5B,EAAuCG,QAAQ,CAACF,KAAD,CAA/C,EAAwDjF,IAAxD,IAAgEkF,KAAhE;AACA,iBAAK/C,SAAL,CAAeW,OAAf;AACD;;;oCAESkC,O,EAAS;AACjB,gBAAG,CAAC,KAAKzG,KAAL,CAAW4B,QAAX,CAAoB6E,OAApB,CAAJ,EAAiC;AAC/B,mBAAKzG,KAAL,CAAW4B,QAAX,CAAoB6E,OAApB,IAA+B,EAA/B;AACD;;AACD,iBAAKzG,KAAL,CAAW4B,QAAX,CAAoB6E,OAApB,EAA6B,KAAKzG,KAAL,CAAW8B,aAAxC,IAAyD;AAACgB,cAAAA,GAAG,EAAE,EAAN;AAAUC,cAAAA,KAAK,EAAE;AAAjB,aAAzD;AACA,iBAAK/C,KAAL,CAAW8B,aAAX,IAA4B,CAA5B;AACA,iBAAK8B,SAAL,CAAeW,OAAf;AACD;;;uCAEY;AACX,gBAAI,KAAKpE,MAAL,CAAY0G,IAAhB,EAAsB;AACpB,mBAAK1G,MAAL,CAAY0G,IAAZ,IAAoB,OAAO,KAAK3G,WAAL,CAAiBmE,cAA5C;AACD,aAFD,MAEO;AACL,mBAAKlE,MAAL,CAAY0G,IAAZ,GAAmB,KAAK3G,WAAL,CAAiBmE,cAApC;AACD;AACF;;;;QAjT2C3E,S;;;;AAoT9CC,MAAAA,wBAAwB,CAACmH,WAAzB,GAAuC,uCAAvC","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!';\nimport 'sortablejs';\n// var el = document.getElementById('items');\n// var sortable = Sortable.create(el);\n\n\nexport class BosunDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv, $sce) {\n    super($scope, $injector, $sce);\n    this.scope = $scope;\n    this.sce = $sce;\n    this.queryHelper = {};\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.target.expandHelper = 0;\n    this.target.target = this.target.target || 'Bosun Query';\n    this.suggestMetrics = this.suggestMetrics.bind(this);\n    this.addSuggest = this.addSuggest.bind(this);\n    this.labelFromUnit = this.labelFromUnit.bind(this);\n    this.metricInfo = this.metricInfo.bind(this);\n    this.suggestQuery = this.suggestQuery.bind(this);\n    this.suggestTagValues = this.suggestTagValues.bind(this);\n    this.getSubstitutedFinalQuery = this.getSubstitutedFinalQuery.bind(this);\n    this.addNewVariable = this.addNewVariable.bind(this);\n    this.addNewVariableQ = this.addNewVariableQ.bind(this);\n    this.getMetricSuggestions = this.getMetricSuggestions.bind(this);\n    this.buildQueryVariable = this.buildQueryVariable.bind(this);\n    this.addTagBox = this.addTagBox.bind(this);\n    this.filterTypes = [\"Group By\", \"Filter\"]\n    this.scope.variables = {};\n    this.scope.aggOptions = [{text: 'avg'}, {text: 'count'}, {text: 'dev'}, {text: 'diff'}, {text: 'ep50r3'}, {text: 'ep50r7'}, {text: 'ep75r3'}, {text: 'ep75r7'}, {text: 'ep90r3'}, {text: 'ep90r7'}, {text: 'ep95r3'}, {text: 'ep95r7'}, {text: 'ep99r3'}, {text: 'ep99r7'}, {text: 'ep999r3'}, {text: 'ep999r7'}, {text: 'first'}, {text: 'last'}, {text: 'median'}, {text: 'mimmin'}, {text: 'mimmax'}, {text: 'min'}, {text: 'max'}, {text: 'mult'}, {text: 'none'}, {text: 'p50'}, {text: 'p75'}, {text: 'p90'}, {text: 'p95'}, {text: 'p99'}, {text: 'p999'}, {text: 'pfsum'}, {text: 'sum'}, {text: 'zimsum'}];\n    this.scope.fillPolicies = [{text: 'none'}, {text: 'nan'}, {text: 'null'}, {text: 'zero'}];\n    this.scope.queryFunctions = [\n      {func: 'q', type:'seriesSet', args:{'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {func: 'band', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}},\n      {func: 'over', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}},\n      {func: 'shiftBand', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}},\n      {func: 'change', type:'numberSet', args:{'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {func: 'count', type:'scalar', args:{'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {func: 'window', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar', 'funcName': 'string'}},\n    ];\n    this.scope.suggestions = [];\n    this.scope.tagBoxes = {};\n    this.scope.varCounter = 0;\n    this.scope.tagBoxCounter = 0;\n    this.scope.finalQuery = \"\";\n  }\n\n  suggestMetrics(metric, callback) {\n    return this.datasource._metricsStartWith(metric).then(callback);\n  }\n\n  metricInfo() {\n    return this.datasource._tagKeysForMetric(this.queryHelper.metric).then((tagKeys) => {\n      this.datasource.q.all(_.map(tagKeys, (tagKey) => {\n        return this.datasource._tagValuesForMetricAndTagKey(this.queryHelper.metric, tagKey).then((tagValues) => {\n          return { key: tagKey, value: tagValues }\n        })\n      })\n      ).then((tagKeysToValues) => {\n        tagKeysToValues = _.each(tagKeysToValues, (v) => { v.filterType = \"Group By\" })\n        this.queryHelper.tagKeysToValues = tagKeysToValues;\n      })\n    }).then(() => this.datasource._metricMetadata(this.queryHelper.metric).then((metadata) => {\n      this.queryHelper.rate = metadata.Rate;\n      this.queryHelper.unit = metadata.Unit;\n      this.queryHelper.desc = metadata.Desc;\n    })).then(() => this.suggestQuery());\n  }\n\n  // Expects that getTags has been called\n  suggestTagValues(key, callback) {\n    return this.queryHelper.tagKeysToValues[key].then(callback)\n  }\n\n  labelFromUnit() {\n    if (this.panelCtrl.panel.type === \"graph\") {\n      this.panelCtrl.panel.yaxes[0].label = this.queryHelper.unit;\n    }\n    if (this.panelCtrl.panel.type === \"singlestat\") {\n      this.panelCtrl.panel.postfix = \" \" + this.queryHelper.unit;\n    }\n  }\n\n  suggestQuery() {\n    var metric = this.queryHelper.metric || \"metric.goes.here\";\n    var selectedGroupByTags = [];\n    var selectedFilterTags = [];\n    _.each(this.queryHelper.tagKeysToValues, (v) => {\n      if (v.selectedValue && v.selectedValue != \"\") {\n        if (v.filterType === this.filterTypes[0]) {\n          selectedGroupByTags.push(v.key + \"=\" + v.selectedValue);\n        }\n        if (v.filterType === this.filterTypes[1]) {\n          selectedFilterTags.push(v.key + \"=\" + v.selectedValue);\n        }\n      }\n    }, this);\n    var rate = \"\";\n    if (this.queryHelper.rate && this.queryHelper.rate == \"counter\") {\n      rate = \"rate{counter,,1}:\"\n    }\n    this.queryHelper.suggestedQuery = \"q(\\\"avg:$ds-avg:\" + rate + metric + \"{\" + selectedGroupByTags.join(\",\") + \"}\" + \"{\" + selectedFilterTags.join(\",\") + \"}\" + \"\\\", \\\"$start\\\", \\\"\\\")\"\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n  getMetricSuggestions(typeahead) {\n    if(!this.datasource.openTSDBUrl){\n      throw ReferenceError(\"Missing OpenTSDB URL\")\n    }\n    var request = new Request(this.datasource.openTSDBUrl + \"/suggest?type=metrics&q=\" + typeahead);\n\n    var the_scope = this.scope\n    var req = fetch(request).then(function(response) {\n      return response.json();\n    }).then(function(responseSuggestions) {\n      the_scope.suggestions = responseSuggestions;\n    }).catch(function(error) {\n      throw error;\n    });\n    this.panelCtrl.refresh();\n    return req\n  }\n\n  getSubstitutedFinalQuery(finalQuery) {\n    //Dictionary doesn't guarantee ordering, so convert to array and sort by key\n    var values = new Array();\n    for (var id in this.scope.variables) {\n      this.scope.variables[id][\"id\"] = id;\n      values.push(this.scope.variables[id]);\n    }\n    values.sort()\n    values = values.reverse()\n\n    var the_scope = this\n\n    var substitutedFinalQuery = finalQuery\n    values.forEach(function(value) {\n      if(value.type == \"variable\") {\n\n        if (value[\"name\"] && value[\"name\"].startsWith(\"$\")) {\n          if (value[\"value\"] == undefined) {\n            substitutedFinalQuery = substitutedFinalQuery.split(value[\"name\"]).join(\"\");\n          } else {\n            substitutedFinalQuery = substitutedFinalQuery.split(value[\"name\"]).join(value[\"value\"]);\n          }\n        }\n      }\n      if(value.type == \"queryVariable\") {\n        substitutedFinalQuery = substitutedFinalQuery.split(value.value[\"queryVariableName\"]).join(the_scope.buildQueryVariable(value, value.id));\n      }\n    });\n    return substitutedFinalQuery;\n  }\n\n  updateFinalQuery(finalQuery) {\n    this.scope.finalQuery = finalQuery;\n    console.log(this.getSubstitutedFinalQuery(finalQuery))\n    this.panelCtrl.refresh();\n  }\n\n  addVariableValue(inputValue, id) {\n    if(this.scope.variables[id]){\n      this.scope.variables[id][\"value\"] = inputValue;\n    }else{\n      throw new ReferenceError(\"When trying to add value the requested variable id could not be found\")\n    }\n    this.panelCtrl.refresh();\n  }\n\n  buildQueryVariable(parameterObject, id) {\n\n    var $scope = this.scope;\n    var params = parameterObject.value;\n    var constructedQuery = \"\";\n    if(!params){\n      throw new ReferenceError(\"No query parameters found\")\n    }\n    if(params[\"queryFunction\"]){\n      constructedQuery += params[\"queryFunction\"] + '(\"'\n    }else{\n      throw new ReferenceError(\"Query function not set\")\n    }\n    if(params[\"queryAgg\"]){\n      constructedQuery += params[\"queryAgg\"] + \":\"\n    }else{\n      throw new ReferenceError(\"Query aggregator not set\")\n    }\n    if(params[\"downsampleTime\"]){\n      constructedQuery += params[\"downsampleTime\"]\n      if(params[\"downsampleAgg\"]){\n        constructedQuery += \"-\" + params[\"downsampleAgg\"]\n      }\n      if(params[\"fillPolicy\"]){\n        constructedQuery += \"-\" + params[\"fillPolicy\"]\n      }\n    }\n    if(params[\"conversionFlag\"]){\n      constructedQuery += \":\" + params[\"conversionFlag\"]\n    }\n    if(params[\"metric\"]){\n      constructedQuery += \":\" + params[\"metric\"] + \"{\"\n    }else{\n      throw new ReferenceError(\"Query metric not set\")\n    }\n    if(params[\"metricTags\"]){\n      constructedQuery += params[\"metricTags\"]\n    }\n    constructedQuery += \"}\"\n    if($scope.tagBoxes[id]){\n      var onFirstTag = true\n\n      constructedQuery += \"{\"\n      for (var tagMapping in $scope.tagBoxes[id]) {\n        if ($scope.tagBoxes[id].hasOwnProperty(tagMapping)) {\n          if(!onFirstTag){\n            constructedQuery += \", \"\n          }else{onFirstTag = false;}\n          constructedQuery += $scope.tagBoxes[id][tagMapping][\"key\"] + \"=\" + $scope.tagBoxes[id][tagMapping][\"value\"]\n        }\n      }\n      constructedQuery += '}\"'\n    }else{\n      constructedQuery += '{}\"'\n    }\n    if(params[\"startDuration\"]){\n      constructedQuery += ', \"' + params[\"startDuration\"] + '\"'\n    }\n    if(params[\"endDuration\"]){\n      constructedQuery += ', \"' + params[\"endDuration\"] + '\"'\n    }\n    if(params[\"duration\"]){\n      constructedQuery += ', \"' + params[\"duration\"] + '\"'\n    }\n    if(params[\"period\"]){\n      constructedQuery += ', \"' + params[\"period\"] + '\"'\n    }\n    if(params[\"num\"]){\n      constructedQuery += ', \"' + params[\"num\"] + '\"'\n    }\n    if(params[\"funcName\"]){\n      constructedQuery += ', \"' + params[\"funcName\"] + '\"'\n    }\n    constructedQuery += \")\";\n    this.panelCtrl.refresh();\n    console.log(constructedQuery);\n    return constructedQuery;\n  }\n\n  addQueryVariableParameter(inputType, inputValue, id) {\n    if(this.scope.variables[id]){\n      if(!this.scope.variables[id][\"value\"]){\n        this.scope.variables[id][\"value\"] = {}\n      }\n      this.scope.variables[id][\"value\"][inputType] = inputValue;\n    }else{\n      throw new ReferenceError(\"Requested queryVariable id could not be found\")\n    }\n    this.panelCtrl.refresh();\n  }\n\n  addVariableName(inputName, id) {\n    if(this.scope.variables[id]){\n      this.scope.variables[id][\"name\"] = inputName;\n    }else{\n      throw new ReferenceError(\"When trying to add name the requested variable id could not be found\")\n    }\n    this.panelCtrl.refresh();\n  }\n\n  addNewVariable() {\n    this.scope.variables[this.scope.varCounter] = {type: 'variable'};\n    this.scope.varCounter += 1;\n    this.panelCtrl.refresh();\n  }\n\n  addNewVariableQ() {\n    console.log(this.scope)\n    this.scope.variables[this.scope.varCounter] = {type: 'queryVariable'};\n    this.scope.varCounter += 1;\n    this.panelCtrl.refresh();\n  }\n\n  substituteVariables(finalQuery) {\n    //TODO\n    this.panelCtrl.refresh();\n  }\n\n  editTagBox(queryId, tagId, input, type) {\n    this.scope.tagBoxes[parseInt(queryId)][parseInt(tagId)][type] = input;\n    this.panelCtrl.refresh();\n  }\n\n  addTagBox(queryId) {\n    if(!this.scope.tagBoxes[queryId]){\n      this.scope.tagBoxes[queryId] = {}\n    }\n    this.scope.tagBoxes[queryId][this.scope.tagBoxCounter] = {key: \"\", value: \"\"};\n    this.scope.tagBoxCounter += 1;\n    this.panelCtrl.refresh();\n  }\n\n  addSuggest() {\n    if (this.target.expr) {\n      this.target.expr += \"\\n\" + this.queryHelper.suggestedQuery;\n    } else {\n      this.target.expr = this.queryHelper.suggestedQuery;\n    }\n  }\n}\n\nBosunDatasourceQueryCtrl.templateUrl = 'datasource/partials/query.editor.html';\n"],"file":"query_ctrl.js"}