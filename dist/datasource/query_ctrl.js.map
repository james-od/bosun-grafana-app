{"version":3,"sources":["../../src/datasource/query_ctrl.js"],"names":["QueryCtrl","Sortable","substituteFinalQuery","BosunDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","queryHelper","target","expandHelper","deleteVariable","bind","suggestMetrics","addSuggest","labelFromUnit","metricInfo","suggestQuery","suggestTagValues","addNewVariable","getMetricSuggestions","addTagBox","filterTypes","variables","_","orderBy","aggOptions","text","fillPolicies","queryFunctions","func","type","args","suggestions","varCounter","finalQuery","expr","subbedQuery","flags","_this","$","document","ready","setTimeout","setSortable","updateFinalQuery","e","console","log","obj","keys","i","indexOf","Object","prototype","hasOwnProperty","call","htmlCollection","ret","length","push","id","htmlCollectionToListOfIds","getElementById","getElementsByTagName","orderedListOfIds","getVariablesFromUI","indexInUI","toString","el","create","onUpdate","ensureOrdering","typeahead","datasource","openTSDBUrl","ReferenceError","request","Request","the_scope","req","fetch","then","response","json","responseSuggestions","error","tmp","objectWithoutProperties","variableId","tagId","defaultVariable","queryId","defaultTagBox","key","value","editorClosed","queryVariable","panelCtrl","refresh","metric","callback","_metricsStartWith","_tagKeysForMetric","tagKeys","q","all","map","tagKey","_tagValuesForMetricAndTagKey","tagValues","tagKeysToValues","each","v","filterType","_metricMetadata","metadata","rate","Rate","unit","Unit","desc","Desc","panel","yaxes","label","postfix","selectedGroupByTags","selectedFilterTags","selectedValue","suggestedQuery","join","templateUrl"],"mappings":"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","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!';\nimport Sortable from './../external/Sortable.min';\nimport {substituteFinalQuery} from \"./queryBuilderService\";\n\n\nexport class BosunDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n    this.scope = $scope;\n    this.queryHelper = {};\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.target.expandHelper = 0;\n    this.target.target = this.target.target || 'Bosun Query';\n    this.deleteVariable = this.deleteVariable.bind(this);\n    this.suggestMetrics = this.suggestMetrics.bind(this);\n    this.addSuggest = this.addSuggest.bind(this);\n    this.labelFromUnit = this.labelFromUnit.bind(this);\n    this.metricInfo = this.metricInfo.bind(this);\n    this.suggestQuery = this.suggestQuery.bind(this);\n    this.suggestTagValues = this.suggestTagValues.bind(this);\n    this.addNewVariable = this.addNewVariable.bind(this);\n    this.getMetricSuggestions = this.getMetricSuggestions.bind(this);\n    this.addTagBox = this.addTagBox.bind(this);\n    this.filterTypes = [\"Group By\", \"Filter\"];\n    if (!this.target.variables) {\n      this.target.variables = [];\n    } else {\n      this.target.variables = _.orderBy(this.target.variables, ['indexInUI'])\n    }\n    this.scope.aggOptions = [\n      {text: 'avg'}, {text: 'count'}, {text: 'dev'}, {text: 'diff'}, {text: 'ep50r3'}, {text: 'ep50r7'},\n      {text: 'ep75r3'}, {text: 'ep75r7'}, {text: 'ep90r3'}, {text: 'ep90r7'}, {text: 'ep95r3'}, {text: 'ep95r7'},\n      {text: 'ep99r3'}, {text: 'ep99r7'}, {text: 'ep999r3'}, {text: 'ep999r7'}, {text: 'first'}, {text: 'last'},\n      {text: 'median'}, {text: 'mimmin'}, {text: 'mimmax'}, {text: 'min'}, {text: 'max'}, {text: 'mult'},\n      {text: 'none'}, {text: 'p50'}, {text: 'p75'}, {text: 'p90'}, {text: 'p95'}, {text: 'p99'}, {text: 'p999'},\n      {text: 'pfsum'}, {text: 'sum'}, {text: 'zimsum'}\n    ];\n    this.scope.fillPolicies = [{text: 'none'}, {text: 'nan'}, {text: 'null'}, {text: 'zero'}];\n    this.scope.queryFunctions = [\n      {func: 'q', type: 'seriesSet', args: {'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {\n        func: 'band',\n        type: 'seriesSet',\n        args: {'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}\n      },\n      {\n        func: 'over',\n        type: 'seriesSet',\n        args: {'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}\n      },\n      {\n        func: 'shiftBand',\n        type: 'seriesSet',\n        args: {'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}\n      },\n      {\n        func: 'change',\n        type: 'numberSet',\n        args: {'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}\n      },\n      {func: 'count', type: 'scalar', args: {'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {\n        func: 'window',\n        type: 'seriesSet',\n        args: {'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar', 'funcName': 'string'}\n      },\n    ];\n    this.scope.suggestions = [];\n    if (!this.target.varCounter) {\n      this.target.varCounter = 0;\n    }\n    if (!this.target.finalQuery) {\n      if (this.target.expr) {\n        this.target.finalQuery = this.target.expr;\n        this.target.expr = \"\"\n      } else {\n        this.target.finalQuery = \"\";\n      }\n    }\n    this.target.subbedQuery = \"\";\n    if (!this.target.flags) {\n      this.target.flags = \"\";\n    }\n    var _this = this;\n    $(document).ready(function () {\n      //DOM needs to load before element can be set as sortable\n      setTimeout(function () {\n        _this.setSortable();\n      }, 1000);\n    });\n    try {\n      this.updateFinalQuery(this.target.finalQuery);\n    } catch (e) {\n      console.log(e)\n    }\n  }\n\n  objectWithoutProperties(obj, keys) {\n    var target = {};\n    for (var i in obj) {\n      if (keys.indexOf(i) >= 0) continue;\n      if (!Object.prototype.hasOwnProperty.call(obj, i)) continue;\n      target[i] = obj[i];\n    }\n    return target;\n  }\n\n  htmlCollectionToListOfIds(htmlCollection) {\n    var ret = [];\n    for (var i = 0; i < htmlCollection.length; i++) {\n      ret.push(htmlCollection[i].id)\n    }\n    return ret;\n  }\n\n  getVariablesFromUI() {\n    return this.htmlCollectionToListOfIds(\n      document.getElementById('allVariables').getElementsByTagName(\"li\")\n    );\n  }\n\n  ensureOrdering(variables) {\n    this.setSortable();\n    var orderedListOfIds = this.getVariablesFromUI();\n    for (var i = 0; i < variables.length; i++) {\n      variables[i].indexInUI = orderedListOfIds.indexOf(variables[i].id.toString())\n    }\n    return _.orderBy(variables, ['indexInUI'])\n  }\n\n  setSortable() {\n    var el = document.getElementById('allVariables');\n    let _this = this;\n    Sortable.create(el, {\n      onUpdate() {\n        _this.target.variables = _this.ensureOrdering(_this.target.variables)\n      }\n    });\n  }\n\n  getMetricSuggestions(typeahead) {\n    if (!this.datasource.openTSDBUrl) {\n      throw ReferenceError(\"Missing OpenTSDB URL\")\n    }\n    var request = new Request(this.datasource.openTSDBUrl + \"/suggest?type=metrics&q=\" + typeahead);\n\n    var the_scope = this.scope;\n    var req = fetch(request).then(function (response) {\n      return response.json();\n    }).then(function (responseSuggestions) {\n      the_scope.suggestions = responseSuggestions;\n    }).catch(function (error) {\n      throw error;\n    });\n    return req\n  }\n\n  deleteVariable(id) {\n    //Angular keeps track of objects in ng-repeat, removing $$hashkey prevents issues with ordering after deleting.\n    var tmp = [];\n    for (var i = 0; i < this.target.variables.length; i++) {\n      if (this.target.variables[i].id.toString() !== id.toString()) {\n        tmp.push(this.objectWithoutProperties(this.target.variables[i], [\"$$hashKey\"]))\n      }\n    }\n    this.target.variables = tmp;\n  }\n\n  deleteTag(variableId, tagId, type) {\n    delete this.target.variables[variableId][type + \"tagBoxes\"][tagId]\n  }\n\n  addNewVariable(type) {\n    var variables = this.target.variables;\n    const defaultVariable = {id: this.target.varCounter, type: type};\n    variables.push(defaultVariable);\n    this.target.varCounter += 1;\n    var _this = this;\n\n    //timeout necessary as ng-repeat doesn't seem to provide a callback when updated\n    setTimeout(function () {\n      variables = _this.ensureOrdering(variables);\n    }, 100);\n  }\n\n  addTagBox(queryId, type) {\n    const defaultTagBox = {key: \"\", value: \"\", editorClosed: false};\n    var queryVariable = this.target.variables[queryId];\n    if (!queryVariable[type + \"tagBoxes\"]) {\n      queryVariable[type + \"tagBoxes\"] = {}\n    }\n    if (!queryVariable[type + \"TagBoxCounter\"]) {\n      queryVariable[type + \"TagBoxCounter\"] = 0;\n    }\n    queryVariable[type + \"tagBoxes\"][queryVariable[type + \"TagBoxCounter\"]] = defaultTagBox;\n    queryVariable[type + \"TagBoxCounter\"] += 1;\n  }\n\n  updateFinalQuery(finalQuery) {\n    this.target.expr = substituteFinalQuery(finalQuery, this);\n    this.panelCtrl.refresh();\n    this.target.finalQuery = finalQuery;\n    return substituteFinalQuery(finalQuery, this);\n  }\n\n  suggestMetrics(metric, callback) {\n    return this.datasource._metricsStartWith(metric).then(callback);\n  }\n\n  metricInfo() {\n    return this.datasource._tagKeysForMetric(this.queryHelper.metric).then((tagKeys) => {\n      this.datasource.q.all(_.map(tagKeys, (tagKey) => {\n          return this.datasource._tagValuesForMetricAndTagKey(this.queryHelper.metric, tagKey).then((tagValues) => {\n            return {key: tagKey, value: tagValues}\n          })\n        })\n      ).then((tagKeysToValues) => {\n        tagKeysToValues = _.each(tagKeysToValues, (v) => {\n          v.filterType = \"Group By\"\n        });\n        this.queryHelper.tagKeysToValues = tagKeysToValues;\n      })\n    }).then(() => this.datasource._metricMetadata(this.queryHelper.metric).then((metadata) => {\n      this.queryHelper.rate = metadata.Rate;\n      this.queryHelper.unit = metadata.Unit;\n      this.queryHelper.desc = metadata.Desc;\n    })).then(() => this.suggestQuery());\n  }\n\n  // Expects that getTags has been called\n  suggestTagValues(key, callback) {\n    return this.queryHelper.tagKeysToValues[key].then(callback)\n  }\n\n  labelFromUnit() {\n    if (this.panelCtrl.panel.type === \"graph\") {\n      this.panelCtrl.panel.yaxes[0].label = this.queryHelper.unit;\n    }\n    if (this.panelCtrl.panel.type === \"singlestat\") {\n      this.panelCtrl.panel.postfix = \" \" + this.queryHelper.unit;\n    }\n  }\n\n  suggestQuery() {\n    var metric = this.queryHelper.metric || \"metric.goes.here\";\n    var selectedGroupByTags = [];\n    var selectedFilterTags = [];\n    _.each(this.queryHelper.tagKeysToValues, (v) => {\n      if (v.selectedValue && v.selectedValue != \"\") {\n        if (v.filterType === this.filterTypes[0]) {\n          selectedGroupByTags.push(v.key + \"=\" + v.selectedValue);\n        }\n        if (v.filterType === this.filterTypes[1]) {\n          selectedFilterTags.push(v.key + \"=\" + v.selectedValue);\n        }\n      }\n    }, this);\n    var rate = \"\";\n    if (this.queryHelper.rate && this.queryHelper.rate == \"counter\") {\n      rate = \"rate{counter,,1}:\"\n    }\n    this.queryHelper.suggestedQuery = \"q(\\\"avg:$ds-avg:\" + rate + metric + \"{\" + selectedGroupByTags.join(\",\") + \"}\" + \"{\" + selectedFilterTags.join(\",\") + \"}\" + \"\\\", \\\"$start\\\", \\\"\\\")\"\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n  addSuggest() {\n    if (this.target.expr) {\n      this.target.expr += \"\\n\" + this.queryHelper.suggestedQuery;\n    } else {\n      this.target.expr = this.queryHelper.suggestedQuery;\n    }\n  }\n}\n\nexport default {BosunDatasourceQueryCtrl}\nBosunDatasourceQueryCtrl.templateUrl = 'datasource/partials/query.editor.html';\n"],"file":"query_ctrl.js"}