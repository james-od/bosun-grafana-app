{"version":3,"sources":["../../src/datasource/query_ctrl.js"],"names":["QueryCtrl","Sortable","QueryBuilderService","BosunDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","$sce","scope","sce","queryHelper","target","expandHelper","setSortable","bind","deleteVariable","suggestMetrics","addSuggest","labelFromUnit","metricInfo","suggestQuery","suggestTagValues","addNewVariable","getMetricSuggestions","addFilterTagBox","addGroupTagBox","filterTypes","variables","_","orderBy","aggOptions","text","fillPolicies","queryFunctions","func","type","args","suggestions","varCounter","finalQuery","expr","console","log","subbedQuery","flags","_this","$","document","ready","setTimeout","updateFinalQuery","e","obj","keys","i","indexOf","Object","prototype","hasOwnProperty","call","id","tmp","length","toString","push","_objectWithoutProperties","variableId","tagId","filtertagBoxes","grouptagBoxes","htmlCollection","ret","el","getElementById","sortable","create","onUpdate","evt","to","children","orderedListOfIds","htmlCollectionToListOfIds","indexInUI","metric","callback","datasource","_metricsStartWith","then","_tagKeysForMetric","tagKeys","q","all","map","tagKey","_tagValuesForMetricAndTagKey","tagValues","key","value","tagKeysToValues","each","v","filterType","_metricMetadata","metadata","rate","Rate","unit","Unit","desc","Desc","panelCtrl","panel","yaxes","label","postfix","selectedGroupByTags","selectedFilterTags","selectedValue","suggestedQuery","join","refresh","typeahead","openTSDBUrl","ReferenceError","request","Request","the_scope","req","fetch","response","json","responseSuggestions","error","qbs","substituteFinalQuery","getElementsByTagName","queryId","filterTagBoxCounter","editorClosed","groupTagBoxCounter","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQA,MAAAA,S,kBAAAA,S;;AAEDC,MAAAA,Q;;AACCC,MAAAA,mB,wBAAAA,mB;;;0CAGKC,wB;;;AAEX,0CAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,YAA/B,EAA6CC,IAA7C,EAAmD;AAAA;;AAAA;;AACjD,yGAAMH,MAAN,EAAcC,SAAd,EAAyBE,IAAzB;AACA,iBAAKC,KAAL,GAAaJ,MAAb;AACA,iBAAKK,GAAL,GAAWF,IAAX;AACA,iBAAKG,WAAL,GAAmB,EAAnB;AACA,iBAAKJ,YAAL,GAAoBA,YAApB;AACA,iBAAKK,MAAL,CAAYC,YAAZ,GAA2B,CAA3B;AACA,iBAAKD,MAAL,CAAYA,MAAZ,GAAqB,OAAKA,MAAL,CAAYA,MAAZ,IAAsB,aAA3C;AACA,iBAAKE,WAAL,GAAmB,OAAKA,WAAL,CAAiBC,IAAjB,gCAAnB;AACA,iBAAKC,cAAL,GAAsB,OAAKA,cAAL,CAAoBD,IAApB,gCAAtB;AACA,iBAAKE,cAAL,GAAsB,OAAKA,cAAL,CAAoBF,IAApB,gCAAtB;AACA,iBAAKG,UAAL,GAAkB,OAAKA,UAAL,CAAgBH,IAAhB,gCAAlB;AACA,iBAAKI,aAAL,GAAqB,OAAKA,aAAL,CAAmBJ,IAAnB,gCAArB;AACA,iBAAKK,UAAL,GAAkB,OAAKA,UAAL,CAAgBL,IAAhB,gCAAlB;AACA,iBAAKM,YAAL,GAAoB,OAAKA,YAAL,CAAkBN,IAAlB,gCAApB;AACA,iBAAKO,gBAAL,GAAwB,OAAKA,gBAAL,CAAsBP,IAAtB,gCAAxB;AACA,iBAAKQ,cAAL,GAAsB,OAAKA,cAAL,CAAoBR,IAApB,gCAAtB;AACA,iBAAKS,oBAAL,GAA4B,OAAKA,oBAAL,CAA0BT,IAA1B,gCAA5B;AACA,iBAAKU,eAAL,GAAuB,OAAKA,eAAL,CAAqBV,IAArB,gCAAvB;AACA,iBAAKW,cAAL,GAAsB,OAAKA,cAAL,CAAoBX,IAApB,gCAAtB;AACA,iBAAKY,WAAL,GAAmB,CAAC,UAAD,EAAa,QAAb,CAAnB;;AACA,cAAG,CAAC,OAAKf,MAAL,CAAYgB,SAAhB,EAA0B;AACxB,mBAAKhB,MAAL,CAAYgB,SAAZ,GAAwB,EAAxB;AACD,WAFD,MAEK;AACH,mBAAKhB,MAAL,CAAYgB,SAAZ,GAAwBC,CAAC,CAACC,OAAF,CAAU,OAAKlB,MAAL,CAAYgB,SAAtB,EAAiC,CAAC,WAAD,CAAjC,CAAxB;AACD;;AACD,iBAAKnB,KAAL,CAAWsB,UAAX,GAAwB,CACtB;AAACC,YAAAA,IAAI,EAAE;AAAP,WADsB,EACP;AAACA,YAAAA,IAAI,EAAE;AAAP,WADO,EACU;AAACA,YAAAA,IAAI,EAAE;AAAP,WADV,EACyB;AAACA,YAAAA,IAAI,EAAE;AAAP,WADzB,EACyC;AAACA,YAAAA,IAAI,EAAE;AAAP,WADzC,EAC2D;AAACA,YAAAA,IAAI,EAAE;AAAP,WAD3D,EAEtB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAFsB,EAEJ;AAACA,YAAAA,IAAI,EAAE;AAAP,WAFI,EAEc;AAACA,YAAAA,IAAI,EAAE;AAAP,WAFd,EAEgC;AAACA,YAAAA,IAAI,EAAE;AAAP,WAFhC,EAEkD;AAACA,YAAAA,IAAI,EAAE;AAAP,WAFlD,EAEoE;AAACA,YAAAA,IAAI,EAAE;AAAP,WAFpE,EAGtB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAHsB,EAGJ;AAACA,YAAAA,IAAI,EAAE;AAAP,WAHI,EAGc;AAACA,YAAAA,IAAI,EAAE;AAAP,WAHd,EAGiC;AAACA,YAAAA,IAAI,EAAE;AAAP,WAHjC,EAGoD;AAACA,YAAAA,IAAI,EAAE;AAAP,WAHpD,EAGqE;AAACA,YAAAA,IAAI,EAAE;AAAP,WAHrE,EAItB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAJsB,EAIJ;AAACA,YAAAA,IAAI,EAAE;AAAP,WAJI,EAIc;AAACA,YAAAA,IAAI,EAAE;AAAP,WAJd,EAIgC;AAACA,YAAAA,IAAI,EAAE;AAAP,WAJhC,EAI+C;AAACA,YAAAA,IAAI,EAAE;AAAP,WAJ/C,EAI8D;AAACA,YAAAA,IAAI,EAAE;AAAP,WAJ9D,EAKtB;AAACA,YAAAA,IAAI,EAAE;AAAP,WALsB,EAKN;AAACA,YAAAA,IAAI,EAAE;AAAP,WALM,EAKS;AAACA,YAAAA,IAAI,EAAE;AAAP,WALT,EAKwB;AAACA,YAAAA,IAAI,EAAE;AAAP,WALxB,EAKuC;AAACA,YAAAA,IAAI,EAAE;AAAP,WALvC,EAKsD;AAACA,YAAAA,IAAI,EAAE;AAAP,WALtD,EAKqE;AAACA,YAAAA,IAAI,EAAE;AAAP,WALrE,EAMtB;AAACA,YAAAA,IAAI,EAAE;AAAP,WANsB,EAML;AAACA,YAAAA,IAAI,EAAE;AAAP,WANK,EAMU;AAACA,YAAAA,IAAI,EAAE;AAAP,WANV,CAAxB;AAQA,iBAAKvB,KAAL,CAAWwB,YAAX,GAA0B,CAAC;AAACD,YAAAA,IAAI,EAAE;AAAP,WAAD,EAAiB;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAjB,EAAgC;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhC,EAAgD;AAACA,YAAAA,IAAI,EAAE;AAAP,WAAhD,CAA1B;AACA,iBAAKvB,KAAL,CAAWyB,cAAX,GAA4B,CAC1B;AAACC,YAAAA,IAAI,EAAE,GAAP;AAAYC,YAAAA,IAAI,EAAC,WAAjB;AAA8BC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,+BAAiB,QAArC;AAA+C,6BAAe;AAA9D;AAAnC,WAD0B,EAE1B;AAACF,YAAAA,IAAI,EAAE,MAAP;AAAeC,YAAAA,IAAI,EAAC,WAApB;AAAiCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO;AAArE;AAAtC,WAF0B,EAG1B;AAACF,YAAAA,IAAI,EAAE,MAAP;AAAeC,YAAAA,IAAI,EAAC,WAApB;AAAiCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO;AAArE;AAAtC,WAH0B,EAI1B;AAACF,YAAAA,IAAI,EAAE,WAAP;AAAoBC,YAAAA,IAAI,EAAC,WAAzB;AAAsCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO;AAArE;AAA3C,WAJ0B,EAK1B;AAACF,YAAAA,IAAI,EAAE,QAAP;AAAiBC,YAAAA,IAAI,EAAC,WAAtB;AAAmCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,+BAAiB,QAArC;AAA+C,6BAAe;AAA9D;AAAxC,WAL0B,EAM1B;AAACF,YAAAA,IAAI,EAAE,OAAP;AAAgBC,YAAAA,IAAI,EAAC,QAArB;AAA+BC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,+BAAiB,QAArC;AAA+C,6BAAe;AAA9D;AAApC,WAN0B,EAO1B;AAACF,YAAAA,IAAI,EAAE,QAAP;AAAiBC,YAAAA,IAAI,EAAC,WAAtB;AAAmCC,YAAAA,IAAI,EAAC;AAAC,uBAAS,QAAV;AAAoB,0BAAY,QAAhC;AAA0C,wBAAU,QAApD;AAA8D,qBAAO,QAArE;AAA+E,0BAAY;AAA3F;AAAxC,WAP0B,CAA5B;AASA,iBAAK5B,KAAL,CAAW6B,WAAX,GAAyB,EAAzB;;AACA,cAAG,CAAC,OAAK1B,MAAL,CAAY2B,UAAhB,EAA2B;AACzB,mBAAK3B,MAAL,CAAY2B,UAAZ,GAAyB,CAAzB;AACD;;AACD,cAAG,CAAC,OAAK3B,MAAL,CAAY4B,UAAhB,EAA2B;AACzB,gBAAG,OAAK5B,MAAL,CAAY6B,IAAf,EAAoB;AAClB,qBAAK7B,MAAL,CAAY4B,UAAZ,GAAyB,OAAK5B,MAAL,CAAY6B,IAArC;AACA,qBAAK7B,MAAL,CAAY6B,IAAZ,GAAmB,EAAnB;AACD,aAHD,MAGK;AACH,qBAAK7B,MAAL,CAAY4B,UAAZ,GAAyB,EAAzB;AACD;AACF;;AACDE,UAAAA,OAAO,CAACC,GAAR,CAAY,OAAK/B,MAAL,CAAY4B,UAAxB;AACA,iBAAK5B,MAAL,CAAYgC,WAAZ,GAA0B,EAA1B;;AACA,cAAG,CAAC,OAAKhC,MAAL,CAAYiC,KAAhB,EAAsB;AACpB,mBAAKjC,MAAL,CAAYiC,KAAZ,GAAoB,EAApB;AACD;;AACD,cAAIC,KAAK,iCAAT;;AACAC,UAAAA,CAAC,CAACC,QAAD,CAAD,CAAYC,KAAZ,CAAkB,YAAU;AAC1B;AACAC,YAAAA,UAAU,CAAC,YAAU;AACnBJ,cAAAA,KAAK,CAAChC,WAAN;AACD,aAFS,EAEP,IAFO,CAAV;AAGD,WALD;;AAMA,cAAG;AACD,mBAAKqC,gBAAL,CAAsB,OAAKvC,MAAL,CAAY4B,UAAlC;AACD,WAFD,CAEC,OAAOY,CAAP,EAAU;AACTV,YAAAA,OAAO,CAACC,GAAR,CAAYS,CAAZ;AACD;;AAxEgD;AAyElD;;;;mDAEwBC,G,EAAKC,I,EAAM;AAClC,gBAAI1C,MAAM,GAAG,EAAb;;AACA,iBAAK,IAAI2C,CAAT,IAAcF,GAAd,EAAmB;AACjB,kBAAIC,IAAI,CAACE,OAAL,CAAaD,CAAb,KAAmB,CAAvB,EAA0B;AAC1B,kBAAI,CAACE,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCP,GAArC,EAA0CE,CAA1C,CAAL,EAAmD;AACnD3C,cAAAA,MAAM,CAAC2C,CAAD,CAAN,GAAYF,GAAG,CAACE,CAAD,CAAf;AACD;;AACD,mBAAO3C,MAAP;AACD;;;yCAEciD,E,EAAI;AACjB,gBAAIC,GAAG,GAAG,EAAV;;AACA,iBAAK,IAAIP,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK3C,MAAL,CAAYgB,SAAZ,CAAsBmC,MAA1C,EAAkDR,CAAC,EAAnD,EAAuD;AACrD,kBAAI,KAAK3C,MAAL,CAAYgB,SAAZ,CAAsB2B,CAAtB,EAAyBM,EAAzB,CAA4BG,QAA5B,OAA2CH,EAAE,CAACG,QAAH,EAA/C,EAA8D;AAC5DF,gBAAAA,GAAG,CAACG,IAAJ,CAAS,KAAKC,wBAAL,CAA8B,KAAKtD,MAAL,CAAYgB,SAAZ,CAAsB2B,CAAtB,CAA9B,EAAwD,CAAC,WAAD,CAAxD,CAAT;AACD;AACF;;AACD,iBAAK3C,MAAL,CAAYgB,SAAZ,GAAwBkC,GAAxB;AACD;;;oCAESK,U,EAAYC,K,EAAOhC,I,EAAK;AAChC,gBAAGA,IAAI,KAAK,QAAZ,EAAqB;AACnB,qBAAO,KAAKxB,MAAL,CAAYgB,SAAZ,CAAsBuC,UAAtB,EAAkCE,cAAlC,CAAiDD,KAAjD,CAAP;AACD;;AACD,gBAAGhC,IAAI,KAAK,OAAZ,EAAoB;AAClB,qBAAO,KAAKxB,MAAL,CAAYgB,SAAZ,CAAsBuC,UAAtB,EAAkCG,aAAlC,CAAgDF,KAAhD,CAAP;AACD;AACF;;;oDAEyBG,c,EAAe;AACvC,gBAAIC,GAAG,GAAG,EAAV;;AACA,iBAAI,IAAIjB,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACgB,cAAc,CAACR,MAA9B,EAAsCR,CAAC,EAAvC,EAA0C;AACxCiB,cAAAA,GAAG,CAACP,IAAJ,CAASM,cAAc,CAAChB,CAAD,CAAd,CAAkBM,EAA3B;AACD;;AACD,mBAAOW,GAAP;AACD;;;wCAEY;AACX,gBAAIC,EAAE,GAAGzB,QAAQ,CAAC0B,cAAT,CAAwB,cAAxB,CAAT;;AACA,gBAAI5B,KAAK,GAAG,IAAZ;;AACA,gBAAI6B,QAAQ,GAAGzE,QAAQ,CAAC0E,MAAT,CAAgBH,EAAhB,EAAoB;AACjCI,cAAAA,QADiC,oBACxBC,GADwB,EACnB;AACZpC,gBAAAA,OAAO,CAACC,GAAR,CAAYmC,GAAG,CAACC,EAAJ,CAAOC,QAAnB;;AACA,oBAAIC,gBAAgB,GAAGnC,KAAK,CAACoC,yBAAN,CAAgCJ,GAAG,CAACC,EAAJ,CAAOC,QAAvC,CAAvB;;AAEA,qBAAI,IAAIzB,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACT,KAAK,CAAClC,MAAN,CAAagB,SAAb,CAAuBmC,MAAtC,EAA8CR,CAAC,EAA/C,EAAkD;AAChDT,kBAAAA,KAAK,CAAClC,MAAN,CAAagB,SAAb,CAAuB2B,CAAvB,EAA0B4B,SAA1B,GAAsCF,gBAAgB,CAACzB,OAAjB,CAAyBV,KAAK,CAAClC,MAAN,CAAagB,SAAb,CAAuB2B,CAAvB,EAA0BM,EAA1B,CAA6BG,QAA7B,EAAzB,CAAtC;AACD;;AACDlB,gBAAAA,KAAK,CAAClC,MAAN,CAAagB,SAAb,GAAyBC,CAAC,CAACC,OAAF,CAAUgB,KAAK,CAAClC,MAAN,CAAagB,SAAvB,EAAkC,CAAC,WAAD,CAAlC,CAAzB;AACD;AATgC,aAApB,CAAf;AAWD;;;yCAEcwD,M,EAAQC,Q,EAAU;AAC/B,mBAAO,KAAKC,UAAL,CAAgBC,iBAAhB,CAAkCH,MAAlC,EAA0CI,IAA1C,CAA+CH,QAA/C,CAAP;AACD;;;uCAEY;AAAA;;AACX,mBAAO,KAAKC,UAAL,CAAgBG,iBAAhB,CAAkC,KAAK9E,WAAL,CAAiByE,MAAnD,EAA2DI,IAA3D,CAAgE,UAACE,OAAD,EAAa;AAClF,cAAA,MAAI,CAACJ,UAAL,CAAgBK,CAAhB,CAAkBC,GAAlB,CAAsB/D,CAAC,CAACgE,GAAF,CAAMH,OAAN,EAAe,UAACI,MAAD,EAAY;AAC/C,uBAAO,MAAI,CAACR,UAAL,CAAgBS,4BAAhB,CAA6C,MAAI,CAACpF,WAAL,CAAiByE,MAA9D,EAAsEU,MAAtE,EAA8EN,IAA9E,CAAmF,UAACQ,SAAD,EAAe;AACvG,yBAAO;AAAEC,oBAAAA,GAAG,EAAEH,MAAP;AAAeI,oBAAAA,KAAK,EAAEF;AAAtB,mBAAP;AACD,iBAFM,CAAP;AAGD,eAJqB,CAAtB,EAKER,IALF,CAKO,UAACW,eAAD,EAAqB;AAC1BA,gBAAAA,eAAe,GAAGtE,CAAC,CAACuE,IAAF,CAAOD,eAAP,EAAwB,UAACE,CAAD,EAAO;AAAEA,kBAAAA,CAAC,CAACC,UAAF,GAAe,UAAf;AAA2B,iBAA5D,CAAlB;AACA,gBAAA,MAAI,CAAC3F,WAAL,CAAiBwF,eAAjB,GAAmCA,eAAnC;AACD,eARD;AASD,aAVM,EAUJX,IAVI,CAUC;AAAA,qBAAM,MAAI,CAACF,UAAL,CAAgBiB,eAAhB,CAAgC,MAAI,CAAC5F,WAAL,CAAiByE,MAAjD,EAAyDI,IAAzD,CAA8D,UAACgB,QAAD,EAAc;AACxF,gBAAA,MAAI,CAAC7F,WAAL,CAAiB8F,IAAjB,GAAwBD,QAAQ,CAACE,IAAjC;AACA,gBAAA,MAAI,CAAC/F,WAAL,CAAiBgG,IAAjB,GAAwBH,QAAQ,CAACI,IAAjC;AACA,gBAAA,MAAI,CAACjG,WAAL,CAAiBkG,IAAjB,GAAwBL,QAAQ,CAACM,IAAjC;AACD,eAJa,CAAN;AAAA,aAVD,EAcHtB,IAdG,CAcE;AAAA,qBAAM,MAAI,CAACnE,YAAL,EAAN;AAAA,aAdF,CAAP;AAeD;;;2CAGgB4E,G,EAAKZ,Q,EAAU;AAC9B,mBAAO,KAAK1E,WAAL,CAAiBwF,eAAjB,CAAiCF,GAAjC,EAAsCT,IAAtC,CAA2CH,QAA3C,CAAP;AACD;;;0CAEe;AACd,gBAAI,KAAK0B,SAAL,CAAeC,KAAf,CAAqB5E,IAArB,KAA8B,OAAlC,EAA2C;AACzC,mBAAK2E,SAAL,CAAeC,KAAf,CAAqBC,KAArB,CAA2B,CAA3B,EAA8BC,KAA9B,GAAsC,KAAKvG,WAAL,CAAiBgG,IAAvD;AACD;;AACD,gBAAI,KAAKI,SAAL,CAAeC,KAAf,CAAqB5E,IAArB,KAA8B,YAAlC,EAAgD;AAC9C,mBAAK2E,SAAL,CAAeC,KAAf,CAAqBG,OAArB,GAA+B,MAAM,KAAKxG,WAAL,CAAiBgG,IAAtD;AACD;AACF;;;yCAEc;AAAA;;AACb,gBAAIvB,MAAM,GAAG,KAAKzE,WAAL,CAAiByE,MAAjB,IAA2B,kBAAxC;AACA,gBAAIgC,mBAAmB,GAAG,EAA1B;AACA,gBAAIC,kBAAkB,GAAG,EAAzB;;AACAxF,YAAAA,CAAC,CAACuE,IAAF,CAAO,KAAKzF,WAAL,CAAiBwF,eAAxB,EAAyC,UAACE,CAAD,EAAO;AAC9C,kBAAIA,CAAC,CAACiB,aAAF,IAAmBjB,CAAC,CAACiB,aAAF,IAAmB,EAA1C,EAA8C;AAC5C,oBAAIjB,CAAC,CAACC,UAAF,KAAiB,MAAI,CAAC3E,WAAL,CAAiB,CAAjB,CAArB,EAA0C;AACxCyF,kBAAAA,mBAAmB,CAACnD,IAApB,CAAyBoC,CAAC,CAACJ,GAAF,GAAQ,GAAR,GAAcI,CAAC,CAACiB,aAAzC;AACD;;AACD,oBAAIjB,CAAC,CAACC,UAAF,KAAiB,MAAI,CAAC3E,WAAL,CAAiB,CAAjB,CAArB,EAA0C;AACxC0F,kBAAAA,kBAAkB,CAACpD,IAAnB,CAAwBoC,CAAC,CAACJ,GAAF,GAAQ,GAAR,GAAcI,CAAC,CAACiB,aAAxC;AACD;AACF;AACF,aATD,EASG,IATH;;AAUA,gBAAIb,IAAI,GAAG,EAAX;;AACA,gBAAI,KAAK9F,WAAL,CAAiB8F,IAAjB,IAAyB,KAAK9F,WAAL,CAAiB8F,IAAjB,IAAyB,SAAtD,EAAiE;AAC/DA,cAAAA,IAAI,GAAG,mBAAP;AACD;;AACD,iBAAK9F,WAAL,CAAiB4G,cAAjB,GAAkC,qBAAqBd,IAArB,GAA4BrB,MAA5B,GAAqC,GAArC,GAA2CgC,mBAAmB,CAACI,IAApB,CAAyB,GAAzB,CAA3C,GAA2E,GAA3E,GAAiF,GAAjF,GAAuFH,kBAAkB,CAACG,IAAnB,CAAwB,GAAxB,CAAvF,GAAsH,GAAtH,GAA4H,uBAA9J;AACD;;;6CAEkB;AACjB,iBAAKT,SAAL,CAAeU,OAAf,GADiB,CACS;AAC3B;;;+CAEoBC,S,EAAW;AAC9B,gBAAG,CAAC,KAAKpC,UAAL,CAAgBqC,WAApB,EAAgC;AAC9B,oBAAMC,cAAc,CAAC,sBAAD,CAApB;AACD;;AACD,gBAAIC,OAAO,GAAG,IAAIC,OAAJ,CAAY,KAAKxC,UAAL,CAAgBqC,WAAhB,GAA8B,0BAA9B,GAA2DD,SAAvE,CAAd;AAEA,gBAAIK,SAAS,GAAG,KAAKtH,KAArB;AACA,gBAAIuH,GAAG,GAAGC,KAAK,CAACJ,OAAD,CAAL,CAAerC,IAAf,CAAoB,UAAS0C,QAAT,EAAmB;AAC/C,qBAAOA,QAAQ,CAACC,IAAT,EAAP;AACD,aAFS,EAEP3C,IAFO,CAEF,UAAS4C,mBAAT,EAA8B;AACpCL,cAAAA,SAAS,CAACzF,WAAV,GAAwB8F,mBAAxB;AACD,aAJS,WAID,UAASC,KAAT,EAAgB;AACvB,oBAAMA,KAAN;AACD,aANS,CAAV;AAOA,mBAAOL,GAAP;AACD;;;2CAEgBxF,U,EAAY;AAC3B,gBAAI8F,GAAG,GAAG,IAAInI,mBAAJ,EAAV;AACA,iBAAKS,MAAL,CAAY6B,IAAZ,GAAmB6F,GAAG,CAACC,oBAAJ,CAAyB/F,UAAzB,EAAqC,IAArC,CAAnB;AACA,iBAAKuE,SAAL,CAAeU,OAAf;AACA,iBAAK7G,MAAL,CAAY4B,UAAZ,GAAyBA,UAAzB;AACA,mBAAO8F,GAAG,CAACC,oBAAJ,CAAyB/F,UAAzB,EAAqC,IAArC,CAAP;AACD;;;yCAEcJ,I,EAAM;AACnB,iBAAKxB,MAAL,CAAYgB,SAAZ,CAAsBqC,IAAtB,CAA2B;AAACJ,cAAAA,EAAE,EAAE,KAAKjD,MAAL,CAAY2B,UAAjB;AAA6BH,cAAAA,IAAI,EAAEA;AAAnC,aAA3B;AACA,iBAAKxB,MAAL,CAAY2B,UAAZ,IAA0B,CAA1B;;AACA,gBAAIO,KAAK,GAAG,IAAZ,CAHmB,CAKnB;;;AACAI,YAAAA,UAAU,CAAC,YAAU;AACnBJ,cAAAA,KAAK,CAAChC,WAAN;;AAEA,kBAAImE,gBAAgB,GAAGnC,KAAK,CAACoC,yBAAN,CAAgClC,QAAQ,CAAC0B,cAAT,CAAwB,cAAxB,EAAwC8D,oBAAxC,CAA6D,IAA7D,CAAhC,CAAvB;;AACA,mBAAI,IAAIjF,CAAC,GAAC,CAAV,EAAaA,CAAC,GAACT,KAAK,CAAClC,MAAN,CAAagB,SAAb,CAAuBmC,MAAtC,EAA8CR,CAAC,EAA/C,EAAkD;AAChDT,gBAAAA,KAAK,CAAClC,MAAN,CAAagB,SAAb,CAAuB2B,CAAvB,EAA0B4B,SAA1B,GAAsCF,gBAAgB,CAACzB,OAAjB,CAAyBV,KAAK,CAAClC,MAAN,CAAagB,SAAb,CAAuB2B,CAAvB,EAA0BM,EAA1B,CAA6BG,QAA7B,EAAzB,CAAtC;AACD;;AAEDlB,cAAAA,KAAK,CAAClC,MAAN,CAAagB,SAAb,GAAyBC,CAAC,CAACC,OAAF,CAAUgB,KAAK,CAAClC,MAAN,CAAagB,SAAvB,EAAkC,CAAC,WAAD,CAAlC,CAAzB;AACD,aATS,EASP,GATO,CAAV;AAYD;;;0CAEe6G,O,EAAS;AACvB,gBAAG,CAAC,KAAK7H,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BpE,cAAnC,EAAkD;AAChD,mBAAKzD,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BpE,cAA/B,GAAgD,EAAhD;AACD;;AACD,gBAAG,CAAC,KAAKzD,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BC,mBAAnC,EAAuD;AACrD,mBAAK9H,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BC,mBAA/B,GAAqD,CAArD;AACD;;AACD,iBAAK9H,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BpE,cAA/B,CAA8C,KAAKzD,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BC,mBAA7E,IAAoG;AAACzC,cAAAA,GAAG,EAAE,EAAN;AAAUC,cAAAA,KAAK,EAAE,EAAjB;AAAqByC,cAAAA,YAAY,EAAE;AAAnC,aAApG;AACA,iBAAK/H,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BC,mBAA/B,IAAsD,CAAtD;AACD;;;yCAEcD,O,EAAS;AACtB,gBAAG,CAAC,KAAK7H,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BnE,aAAnC,EAAiD;AAC/C,mBAAK1D,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BnE,aAA/B,GAA+C,EAA/C;AACD;;AACD,gBAAG,CAAC,KAAK1D,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BG,kBAAnC,EAAsD;AACpD,mBAAKhI,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BG,kBAA/B,GAAoD,CAApD;AACD;;AACD,iBAAKhI,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BnE,aAA/B,CAA6C,KAAK1D,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BG,kBAA5E,IAAkG;AAAC3C,cAAAA,GAAG,EAAE,EAAN;AAAUC,cAAAA,KAAK,EAAE,EAAjB;AAAqByC,cAAAA,YAAY,EAAE;AAAnC,aAAlG;AACA,iBAAK/H,MAAL,CAAYgB,SAAZ,CAAsB6G,OAAtB,EAA+BG,kBAA/B,IAAqD,CAArD;AACD;;;uCAEY;AACX,gBAAI,KAAKhI,MAAL,CAAY6B,IAAhB,EAAsB;AACpB,mBAAK7B,MAAL,CAAY6B,IAAZ,IAAoB,OAAO,KAAK9B,WAAL,CAAiB4G,cAA5C;AACD,aAFD,MAEO;AACL,mBAAK3G,MAAL,CAAY6B,IAAZ,GAAmB,KAAK9B,WAAL,CAAiB4G,cAApC;AACD;AACF;;;;QAxQ2CtH,S;;;;yBA0Q/B;AAAEG,QAAAA,wBAAwB,EAAxBA;AAAF,O;;AACfA,MAAAA,wBAAwB,CAACyI,WAAzB,GAAuC,uCAAvC","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!';\nimport Sortable from './../external/Sortable.min';\nimport {QueryBuilderService} from \"./queryBuilderService\";\n\n\nexport class BosunDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv, $sce) {\n    super($scope, $injector, $sce);\n    this.scope = $scope;\n    this.sce = $sce;\n    this.queryHelper = {};\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.target.expandHelper = 0;\n    this.target.target = this.target.target || 'Bosun Query';\n    this.setSortable = this.setSortable.bind(this);\n    this.deleteVariable = this.deleteVariable.bind( this);\n    this.suggestMetrics = this.suggestMetrics.bind(this);\n    this.addSuggest = this.addSuggest.bind(this);\n    this.labelFromUnit = this.labelFromUnit.bind(this);\n    this.metricInfo = this.metricInfo.bind(this);\n    this.suggestQuery = this.suggestQuery.bind(this);\n    this.suggestTagValues = this.suggestTagValues.bind(this);\n    this.addNewVariable = this.addNewVariable.bind(this);\n    this.getMetricSuggestions = this.getMetricSuggestions.bind(this);\n    this.addFilterTagBox = this.addFilterTagBox.bind(this);\n    this.addGroupTagBox = this.addGroupTagBox.bind(this);\n    this.filterTypes = [\"Group By\", \"Filter\"]\n    if(!this.target.variables){\n      this.target.variables = [];\n    }else{\n      this.target.variables = _.orderBy(this.target.variables, ['indexInUI'])\n    }\n    this.scope.aggOptions = [\n      {text: 'avg'}, {text: 'count'}, {text: 'dev'}, {text: 'diff'}, {text: 'ep50r3'}, {text: 'ep50r7'},\n      {text: 'ep75r3'}, {text: 'ep75r7'}, {text: 'ep90r3'}, {text: 'ep90r7'}, {text: 'ep95r3'}, {text: 'ep95r7'},\n      {text: 'ep99r3'}, {text: 'ep99r7'}, {text: 'ep999r3'}, {text: 'ep999r7'}, {text: 'first'}, {text: 'last'},\n      {text: 'median'}, {text: 'mimmin'}, {text: 'mimmax'}, {text: 'min'}, {text: 'max'}, {text: 'mult'},\n      {text: 'none'}, {text: 'p50'}, {text: 'p75'}, {text: 'p90'}, {text: 'p95'}, {text: 'p99'}, {text: 'p999'},\n      {text: 'pfsum'}, {text: 'sum'}, {text: 'zimsum'}\n    ];\n    this.scope.fillPolicies = [{text: 'none'}, {text: 'nan'}, {text: 'null'}, {text: 'zero'}];\n    this.scope.queryFunctions = [\n      {func: 'q', type:'seriesSet', args:{'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {func: 'band', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}},\n      {func: 'over', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}},\n      {func: 'shiftBand', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar'}},\n      {func: 'change', type:'numberSet', args:{'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {func: 'count', type:'scalar', args:{'query': 'string', 'startDuration': 'string', 'endDuration': 'string'}},\n      {func: 'window', type:'seriesSet', args:{'query': 'string', 'duration': 'string', 'period': 'string', 'num': 'scalar', 'funcName': 'string'}},\n    ];\n    this.scope.suggestions = [];\n    if(!this.target.varCounter){\n      this.target.varCounter = 0;\n    }\n    if(!this.target.finalQuery){\n      if(this.target.expr){\n        this.target.finalQuery = this.target.expr;\n        this.target.expr = \"\"\n      }else{\n        this.target.finalQuery = \"\";\n      }\n    }\n    console.log(this.target.finalQuery)\n    this.target.subbedQuery = \"\";\n    if(!this.target.flags){\n      this.target.flags = \"\";\n    }\n    var _this = this;\n    $(document).ready(function(){\n      //Give time for page to load before setting elements as sortable\n      setTimeout(function(){\n        _this.setSortable();\n      }, 2000);\n    });\n    try{\n      this.updateFinalQuery(this.target.finalQuery);\n    }catch (e) {\n      console.log(e)\n    }\n  }\n\n  _objectWithoutProperties(obj, keys) {\n    var target = {};\n    for (var i in obj) {\n      if (keys.indexOf(i) >= 0) continue;\n      if (!Object.prototype.hasOwnProperty.call(obj, i)) continue;\n      target[i] = obj[i];\n    }\n    return target;\n  }\n\n  deleteVariable(id) {\n    var tmp = [];\n    for (var i = 0; i < this.target.variables.length; i++) {\n      if (this.target.variables[i].id.toString() !== id.toString()) {\n        tmp.push(this._objectWithoutProperties(this.target.variables[i], [\"$$hashKey\"]))\n      }\n    }\n    this.target.variables = tmp;\n  }\n\n  deleteTag(variableId, tagId, type){\n    if(type === 'filter'){\n      delete this.target.variables[variableId].filtertagBoxes[tagId]\n    }\n    if(type === 'group'){\n      delete this.target.variables[variableId].grouptagBoxes[tagId]\n    }\n  }\n\n  htmlCollectionToListOfIds(htmlCollection){\n    var ret = [];\n    for(var i=0; i<htmlCollection.length; i++){\n      ret.push(htmlCollection[i].id)\n    }\n    return ret;\n  }\n\n  setSortable(){\n    var el = document.getElementById('allVariables');\n    let _this = this;\n    var sortable = Sortable.create(el, {\n      onUpdate(evt) {\n        console.log(evt.to.children)\n        var orderedListOfIds = _this.htmlCollectionToListOfIds(evt.to.children);\n\n        for(var i=0; i<_this.target.variables.length; i++){\n          _this.target.variables[i].indexInUI = orderedListOfIds.indexOf(_this.target.variables[i].id.toString())\n        }\n        _this.target.variables = _.orderBy(_this.target.variables, ['indexInUI'])\n      }\n    });\n  }\n\n  suggestMetrics(metric, callback) {\n    return this.datasource._metricsStartWith(metric).then(callback);\n  }\n\n  metricInfo() {\n    return this.datasource._tagKeysForMetric(this.queryHelper.metric).then((tagKeys) => {\n      this.datasource.q.all(_.map(tagKeys, (tagKey) => {\n        return this.datasource._tagValuesForMetricAndTagKey(this.queryHelper.metric, tagKey).then((tagValues) => {\n          return { key: tagKey, value: tagValues }\n        })\n      })\n      ).then((tagKeysToValues) => {\n        tagKeysToValues = _.each(tagKeysToValues, (v) => { v.filterType = \"Group By\" })\n        this.queryHelper.tagKeysToValues = tagKeysToValues;\n      })\n    }).then(() => this.datasource._metricMetadata(this.queryHelper.metric).then((metadata) => {\n      this.queryHelper.rate = metadata.Rate;\n      this.queryHelper.unit = metadata.Unit;\n      this.queryHelper.desc = metadata.Desc;\n    })).then(() => this.suggestQuery());\n  }\n\n  // Expects that getTags has been called\n  suggestTagValues(key, callback) {\n    return this.queryHelper.tagKeysToValues[key].then(callback)\n  }\n\n  labelFromUnit() {\n    if (this.panelCtrl.panel.type === \"graph\") {\n      this.panelCtrl.panel.yaxes[0].label = this.queryHelper.unit;\n    }\n    if (this.panelCtrl.panel.type === \"singlestat\") {\n      this.panelCtrl.panel.postfix = \" \" + this.queryHelper.unit;\n    }\n  }\n\n  suggestQuery() {\n    var metric = this.queryHelper.metric || \"metric.goes.here\";\n    var selectedGroupByTags = [];\n    var selectedFilterTags = [];\n    _.each(this.queryHelper.tagKeysToValues, (v) => {\n      if (v.selectedValue && v.selectedValue != \"\") {\n        if (v.filterType === this.filterTypes[0]) {\n          selectedGroupByTags.push(v.key + \"=\" + v.selectedValue);\n        }\n        if (v.filterType === this.filterTypes[1]) {\n          selectedFilterTags.push(v.key + \"=\" + v.selectedValue);\n        }\n      }\n    }, this);\n    var rate = \"\";\n    if (this.queryHelper.rate && this.queryHelper.rate == \"counter\") {\n      rate = \"rate{counter,,1}:\"\n    }\n    this.queryHelper.suggestedQuery = \"q(\\\"avg:$ds-avg:\" + rate + metric + \"{\" + selectedGroupByTags.join(\",\") + \"}\" + \"{\" + selectedFilterTags.join(\",\") + \"}\" + \"\\\", \\\"$start\\\", \\\"\\\")\"\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n  getMetricSuggestions(typeahead) {\n    if(!this.datasource.openTSDBUrl){\n      throw ReferenceError(\"Missing OpenTSDB URL\")\n    }\n    var request = new Request(this.datasource.openTSDBUrl + \"/suggest?type=metrics&q=\" + typeahead);\n\n    var the_scope = this.scope\n    var req = fetch(request).then(function(response) {\n      return response.json();\n    }).then(function(responseSuggestions) {\n      the_scope.suggestions = responseSuggestions;\n    }).catch(function(error) {\n      throw error;\n    });\n    return req\n  }\n\n  updateFinalQuery(finalQuery) {\n    var qbs = new QueryBuilderService();\n    this.target.expr = qbs.substituteFinalQuery(finalQuery, this);\n    this.panelCtrl.refresh();\n    this.target.finalQuery = finalQuery;\n    return qbs.substituteFinalQuery(finalQuery, this);\n  }\n\n  addNewVariable(type) {\n    this.target.variables.push({id: this.target.varCounter, type: type});\n    this.target.varCounter += 1;\n    var _this = this;\n\n    //timeout necessary as ng-repeat doesn't seem to provide a callback when updated\n    setTimeout(function(){\n      _this.setSortable();\n\n      var orderedListOfIds = _this.htmlCollectionToListOfIds(document.getElementById('allVariables').getElementsByTagName(\"li\"));\n      for(var i=0; i<_this.target.variables.length; i++){\n        _this.target.variables[i].indexInUI = orderedListOfIds.indexOf(_this.target.variables[i].id.toString())\n      }\n\n      _this.target.variables = _.orderBy(_this.target.variables, ['indexInUI'])\n    }, 100);\n\n\n  }\n\n  addFilterTagBox(queryId) {\n    if(!this.target.variables[queryId].filtertagBoxes){\n      this.target.variables[queryId].filtertagBoxes = {}\n    }\n    if(!this.target.variables[queryId].filterTagBoxCounter){\n      this.target.variables[queryId].filterTagBoxCounter = 0;\n    }\n    this.target.variables[queryId].filtertagBoxes[this.target.variables[queryId].filterTagBoxCounter] = {key: \"\", value: \"\", editorClosed: false};\n    this.target.variables[queryId].filterTagBoxCounter += 1;\n  }\n\n  addGroupTagBox(queryId) {\n    if(!this.target.variables[queryId].grouptagBoxes){\n      this.target.variables[queryId].grouptagBoxes = {}\n    }\n    if(!this.target.variables[queryId].groupTagBoxCounter){\n      this.target.variables[queryId].groupTagBoxCounter = 0;\n    }\n    this.target.variables[queryId].grouptagBoxes[this.target.variables[queryId].groupTagBoxCounter] = {key: \"\", value: \"\", editorClosed: false};\n    this.target.variables[queryId].groupTagBoxCounter += 1;\n  }\n\n  addSuggest() {\n    if (this.target.expr) {\n      this.target.expr += \"\\n\" + this.queryHelper.suggestedQuery;\n    } else {\n      this.target.expr = this.queryHelper.suggestedQuery;\n    }\n  }\n}\nexport default { BosunDatasourceQueryCtrl }\nBosunDatasourceQueryCtrl.templateUrl = 'datasource/partials/query.editor.html';\n"],"file":"query_ctrl.js"}